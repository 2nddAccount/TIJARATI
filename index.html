<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>ØªØ¬Ø§Ø±ØªÙŠ â€” TIJARATI</title>

  <script async src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <script async src="https://unpkg.com/lucide@latest" onload="try{window.lucide&&window.lucide.createIcons&&window.lucide.createIcons()}catch(e){}"></script>

  <style>
    :root {
      --bg: #f7f7fb;
      --surface: #ffffff;
      --surface-2: #f1f5f9;
      --fg: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;

      --primary: #0f766e;
      --primary-2: #14b8a6;
      --danger: #ef4444;
      --warn: #f59e0b;
      --success: #10b981;

      --shadow: 0 18px 55px rgba(2, 6, 23, 0.10);
      --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.08);
      --radius: 18px;

      --ring: 0 0 0 3px color-mix(in srgb, var(--primary-2) 35%, transparent);

      --font-ar: "IBM Plex Sans Arabic", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font-latin: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    html.dark {
      --bg: #070b16;
      --surface: #0b1326;
      --surface-2: #0f1b36;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --border: #1b2a4a;

      --shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.45);

      --ring: 0 0 0 3px color-mix(in srgb, var(--primary-2) 45%, transparent);
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: radial-gradient(1000px 500px at 50% -120px, color-mix(in srgb, var(--primary-2) 20%, transparent), transparent 60%), var(--bg);
      color: var(--fg);
      font-family: var(--font-ar);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
    }

    .font-latin {
      font-family: var(--font-latin);
    }

    .screen {
      display: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .screen.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .screen {
        transition: none !important;
      }

      .animate-in,
      .animate-pop {
        animation: none !important;
      }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }

    .chip {
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      border-radius: 999px;
      padding: 0.5rem 0.85rem;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--muted);
      transition: background 150ms ease, color 150ms ease, border-color 150ms ease;
      white-space: nowrap;
    }

    .chip.active {
      background: color-mix(in srgb, var(--primary) 12%, var(--surface));
      border-color: color-mix(in srgb, var(--primary) 40%, var(--border));
      color: var(--fg);
    }

    .input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.85rem 0.95rem;
      font-weight: 600;
      outline: none;
      transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    /* Money input with inline currency (prevents overlap in RTL/LTR) */
    .money-input {
      text-align: right;
      padding-left: 3.25rem;
    }

    .money-currency {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      font-weight: 900;
      color: var(--muted);
      pointer-events: none;
    }

    html[dir="ltr"] .money-input {
      text-align: left;
      padding-left: 0.95rem;
      padding-right: 3.25rem;
    }

    html[dir="ltr"] .money-currency {
      left: auto;
      right: 1rem;
    }

    .input:focus {
      border-color: color-mix(in srgb, var(--primary-2) 55%, var(--border));
      box-shadow: var(--ring);
      background: color-mix(in srgb, var(--surface) 86%, transparent);
    }

    .btn {
      border-radius: 14px;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, opacity 120ms ease;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .safe-bottom {
      padding-bottom: calc(env(safe-area-inset-bottom) + 92px);
    }

    .nav-safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    .glass {
      background: color-mix(in srgb, var(--surface) 70%, transparent);
      backdrop-filter: blur(12px);
      border: 1px solid color-mix(in srgb, var(--border) 75%, transparent);
    }

    .scrollbar-hide::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .animate-in {
      animation: in 220ms ease-out both;
    }

    @keyframes in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-pop {
      animation: pop 180ms ease-out both;
    }

    @keyframes pop {
      from {
        opacity: 0;
        transform: scale(0.98);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="app" class="max-w-md mx-auto min-h-screen relative overflow-hidden flex flex-col">

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 z-[80] flex items-center justify-center">
      <div class="absolute inset-0"
        style="background: radial-gradient(800px 400px at 50% 0%, rgba(20,184,166,0.35), transparent 55%), linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.98));">
      </div>
      <div class="relative text-center text-white animate-in">
        <div class="mx-auto mb-4 w-20 h-20 rounded-2xl flex items-center justify-center p-3"
          style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 20px 50px rgba(0,0,0,0.35);">
          <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
            alt="TIJARATI" class="w-full h-full object-contain" />
        </div>
        <div class="text-2xl font-black tracking-tight">ØªØ¬Ø§Ø±ØªÙŠ</div>
        <div class="text-xs mt-1 text-white/70 font-semibold tracking-[0.2em] uppercase">TIJARATI</div>
        <div class="mt-5 flex items-center justify-center gap-2 text-white/70 text-xs">
          <span class="inline-block w-2 h-2 rounded-full" style="background: rgba(20,184,166,0.95);"></span>
          <span data-i18n="loading">ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦</span>
        </div>
      </div>
    </div>

    <!-- Main container -->
    <div id="main" class="flex-1 relative overflow-hidden flex flex-col">

      <!-- HOME -->
      <section id="home-screen" class="screen active flex-col h-full overflow-y-auto safe-bottom">
        <header class="px-5 pt-6 pb-10 relative">
          <div class="absolute inset-0 -z-10"
            style="background: radial-gradient(900px 340px at 50% 0%, color-mix(in srgb, var(--primary-2) 28%, transparent), transparent 58%), linear-gradient(180deg, color-mix(in srgb, var(--primary) 28%, transparent), transparent 55%);">
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div id="current-date-header" class="text-xs font-bold"
                style="color: color-mix(in srgb, var(--muted) 80%, transparent);"></div>
              <div class="mt-1 flex items-center gap-2">
                <h1 class="text-2xl font-black tracking-tight" data-i18n="appName">ØªØ¬Ø§Ø±ØªÙŠ</h1>
                <span class="px-2 py-0.5 rounded-full text-[11px] font-extrabold"
                  style="background: color-mix(in srgb, var(--primary) 12%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 20%, var(--border)); color: var(--primary-2);">v3</span>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button id="theme-toggle" class="w-10 h-10 rounded-2xl glass flex items-center justify-center"
                aria-label="Toggle theme" title="Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
              </button>
              <button onclick="openSettings()" class="w-10 h-10 rounded-2xl glass flex items-center justify-center"
                aria-label="Settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
              </button>
            </div>
          </div>

          <div class="mt-6 card p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="netProfit">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                <div class="mt-1 flex items-end gap-2">
                  <div id="dashboard-balance" class="text-4xl font-black tracking-tight">0</div>
                  <div class="text-sm font-extrabold" style="color: var(--muted);"><span
                      class="currency-symbol">DH</span></div>
                </div>
              </div>

              <div class="flex flex-col items-end gap-2">
                <div class="flex rounded-2xl p-1"
                  style="background: var(--surface-2); border: 1px solid var(--border);">
                  <button id="range-today" class="px-3 py-1.5 rounded-xl text-xs font-extrabold"
                    onclick="setDashboardRange('today')" data-i18n="today">Ø§Ù„ÙŠÙˆÙ…</button>
                  <button id="range-all" class="px-3 py-1.5 rounded-xl text-xs font-extrabold"
                    onclick="setDashboardRange('all')" data-i18n="allTime">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</button>
                </div>
                <div class="text-[11px] font-bold" style="color: var(--muted);"><span data-i18n="cashFlow">ØªØ¯ÙÙ‚
                    Ù†Ù‚Ø¯ÙŠ</span></div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-2xl p-4"
                style="background: color-mix(in srgb, var(--success) 12%, var(--surface)); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border));">
                <div class="flex items-center justify-between">
                  <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="income">Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„</div>
                  <div class="w-8 h-8 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--success) 18%, transparent); color: var(--success);">
                    <i data-lucide="arrow-down-left" class="w-4 h-4"></i>
                  </div>
                </div>
                <div class="mt-2 font-black text-xl" style="color: var(--success);">
                  <span id="dashboard-income">0</span> <span class="text-xs font-extrabold currency-symbol"
                    style="color: color-mix(in srgb, var(--success) 70%, var(--muted));">DH</span>
                </div>
              </div>

              <div class="rounded-2xl p-4"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 16%, var(--border));">
                <div class="flex items-center justify-between">
                  <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="expenses">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                  <div class="w-8 h-8 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--danger) 18%, transparent); color: var(--danger);">
                    <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                  </div>
                </div>
                <div class="mt-2 font-black text-xl" style="color: var(--danger);">
                  <span id="dashboard-expense">0</span> <span class="text-xs font-extrabold currency-symbol"
                    style="color: color-mix(in srgb, var(--danger) 70%, var(--muted));">DH</span>
                </div>
              </div>
            </div>

            <div id="debt-alert" class="hidden mt-4 rounded-2xl p-4 flex items-center justify-between cursor-pointer"
              onclick="showScreen('debts-screen')"
              style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                  style="background: color-mix(in srgb, var(--warn) 18%, transparent); color: var(--warn);">
                  <i data-lucide="alert-circle" class="w-5 h-5"></i>
                </div>
                <div>
                  <div class="text-sm font-black" data-i18n="pendingDebts">Ø¯ÙŠÙˆÙ† Ù…Ø¹Ù„Ù‚Ø©</div>
                  <div class="text-xs font-extrabold" style="color: color-mix(in srgb, var(--warn) 70%, var(--muted));">
                    <span id="total-pending-debt">0</span> <span class="currency-symbol">DH</span>
                  </div>
                </div>
              </div>
              <i data-lucide="chevron-left" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-black" data-i18n="quickActions">Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
              <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="tips">Ù†ØµÙŠØ­Ø©: Ø§Ø¶ØºØ· (+) Ù„Ù„Ø¥Ø¶Ø§ÙØ©
                Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <button onclick="startFlow('sale')" class="btn card p-4 border-0 text-white"
                style="background: linear-gradient(135deg, color-mix(in srgb, var(--success) 75%, var(--primary-2)), var(--primary)); box-shadow: 0 18px 40px rgba(15,118,110,0.30);">
                <div class="flex items-center justify-between">
                  <div class="text-right">
                    <div class="text-lg font-black" data-i18n="newSale">Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯</div>
                    <div class="text-xs font-bold text-white/85" data-i18n="saleHint">Ø¯Ø®Ù„ ÙÙ„ÙˆØ³</div>
                  </div>
                  <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                    style="background: rgba(255,255,255,0.16);">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                  </div>
                </div>
              </button>

              <button onclick="startFlow('purchase')" class="btn card p-4" style="background: var(--surface);">
                <div class="flex items-center justify-between">
                  <div class="text-right">
                    <div class="text-lg font-black" data-i18n="newPurchase">Ø´Ø±Ø§Ø¡ Ø³Ù„Ø¹Ø©</div>
                    <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="purchaseHint">Ø®Ø±Ø¬ ÙÙ„ÙˆØ³</div>
                  </div>
                  <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--warn) 16%, transparent); color: var(--warn);">
                    <i data-lucide="package-plus" class="w-5 h-5"></i>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div class="mt-6">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-black" data-i18n="recentActivity">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
              <button onclick="showScreen('history-screen')" class="text-sm font-black" style="color: var(--primary-2);"
                data-i18n="seeAll">Ø´ÙˆÙ Ø§Ù„ÙƒÙ„</button>
            </div>
            <div id="recent-transactions-list" class="mt-3 space-y-3"></div>
          </div>
        </header>
      </section>

      <!-- HISTORY -->
      <section id="history-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="transactions">Ø§Ù„Ø³Ø¬Ù„</div>
            <button onclick="openSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-4">
            <div class="relative">
              <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);">
                <i data-lucide="search" class="w-5 h-5"></i>
              </span>
              <input id="history-search" class="input pr-12" type="text" placeholder="Ø¨Ø­Ø«â€¦" oninput="renderHistory()" />
            </div>
            <div class="mt-3 flex gap-2 overflow-x-auto scrollbar-hide pb-1" id="history-filters"></div>
          </div>
        </header>

        <div id="full-history-list" class="flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-4"></div>
      </section>

      <!-- DEBTS -->
      <section id="debts-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-6 pb-5 sticky top-0 z-10"
          style="background: radial-gradient(900px 340px at 50% 0%, color-mix(in srgb, var(--warn) 22%, transparent), transparent 60%), linear-gradient(180deg, color-mix(in srgb, var(--warn) 12%, transparent), transparent 65%);">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: color-mix(in srgb, var(--surface) 70%, transparent); border: 1px solid var(--border);"
              aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div>
              <div class="text-lg font-black" data-i18n="creditBook">Ø¯ÙØªØ± Ø§Ù„ÙƒØ±ÙŠØ¯ÙŠ</div>
              <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="peopleOweYou">Ù†Ø§Ø³ ÙƒÙŠØªØ³Ø§Ù„ÙˆÙƒ</div>
            </div>
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: color-mix(in srgb, var(--warn) 16%, transparent); color: var(--warn); border: 1px solid color-mix(in srgb, var(--warn) 20%, var(--border));">
              <i data-lucide="book-open" class="w-5 h-5"></i>
            </div>
          </div>

          <div class="mt-4 card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="pendingDebts">Ø¯ÙŠÙˆÙ† Ù…Ø¹Ù„Ù‚Ø©
                </div>
                <div class="mt-1 text-3xl font-black" style="color: color-mix(in srgb, var(--warn) 90%, var(--fg));">
                  <span id="debts-total">0</span> <span class="text-sm currency-symbol">DH</span>
                </div>
              </div>
              <button onclick="renderDebts(true)" class="btn px-4 py-3 rounded-2xl"
                style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Refresh">
                <div class="flex items-center gap-2">
                  <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  <span class="text-xs font-black" data-i18n="refresh">ØªØ­Ø¯ÙŠØ«</span>
                </div>
              </button>
            </div>
          </div>
        </header>

        <div class="px-5 pt-4 pb-10 safe-bottom overflow-y-auto flex-1">
          <div class="relative">
            <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);"><i data-lucide="search"
                class="w-5 h-5"></i></span>
            <input id="debts-search" class="input pr-12" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ù„Ø¹Ø©â€¦"
              oninput="renderDebts()" />
          </div>
          <div id="debts-list" class="mt-4 space-y-3"></div>
        </div>
      </section>

      <!-- PARTNERS / STOCK -->
      <section id="partners-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="partners">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</div>
            <button onclick="openSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-4 flex rounded-2xl p-1" style="background: var(--surface-2); border: 1px solid var(--border);">
            <button id="tab-stock" onclick="switchPartnerTab('stock')"
              class="flex-1 py-2 rounded-xl font-black text-sm" data-i18n="stock">Ø§Ù„Ø³Ù„Ø¹Ø©</button>
            <button id="tab-partners" onclick="switchPartnerTab('partners')"
              class="flex-1 py-2 rounded-xl font-black text-sm" style="color: var(--muted);" data-i18n="partners">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</button>
          </div>
        </header>

        <div id="stock-view" class="flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-3"></div>

        <div id="partners-view" class="hidden flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-base font-black" data-i18n="addPartner">Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠÙƒ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="partnerHint">Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù†
                  Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
              </div>
              <i data-lucide="users" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-6 gap-2">
              <input id="partner-name" class="input col-span-4" type="text" placeholder="Ø§Ù„Ø§Ø³Ù…â€¦" />
              <input id="partner-percent" class="input col-span-2 text-center" type="number" placeholder="%" min="0"
                max="100" />
            </div>
            <button onclick="addPartner()" class="btn w-full mt-3 py-3 text-white"
              style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
              <span data-i18n="add">Ø¥Ø¶Ø§ÙØ©</span>
            </button>
          </div>

          <div id="partners-summary" class="card p-4"></div>
          <div id="partners-list" class="space-y-3"></div>
        </div>
      </section>

      <!-- SETTINGS (Overlay) -->
      <section id="settings-screen" class="screen flex-col h-full absolute inset-0 z-[70]"
        style="background: var(--bg);">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="closeSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="w-10 h-10"></div>
          </div>
        </header>

        <div class="px-5 pt-4 pb-10 safe-bottom overflow-y-auto">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="appearance">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="appearanceHint">Light / Dark
                </div>
              </div>
              <button id="settings-theme" class="btn px-4 py-2 rounded-2xl"
                style="background: var(--surface-2); border: 1px solid var(--border);">
                <span id="settings-theme-label" class="text-sm font-black">Dark</span>
              </button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="language">Ø§Ù„Ù„ØºØ©</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="languageHint">Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                </div>
              </div>
              <i data-lucide="languages" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button onclick="setLanguage('darija')" class="lang-btn btn py-3"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="darija">ğŸ‡²ğŸ‡¦
                Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
              <button onclick="setLanguage('arabic')" class="lang-btn btn py-3"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="arabic">ğŸ‡¸ğŸ‡¦
                Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
              <button onclick="setLanguage('french')" class="lang-btn btn py-3 font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="french">ğŸ‡«ğŸ‡·
                FranÃ§ais</button>
              <button onclick="setLanguage('english')" class="lang-btn btn py-3 font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="english">ğŸ‡¬ğŸ‡§
                English</button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="currency">Ø§Ù„Ø¹Ù…Ù„Ø©</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="currencyHint">Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØªÙ…
                  ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
              </div>
              <i data-lucide="coins" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <button onclick="setCurrency('MAD')" class="curr-btn btn py-3 font-black"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="MAD">MAD</button>
              <button onclick="setCurrency('EUR')" class="curr-btn btn py-3 font-black font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="EUR">EUR</button>
              <button onclick="setCurrency('USD')" class="curr-btn btn py-3 font-black font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="USD">USD</button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="data">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="dataHint">ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­
                </div>
              </div>
              <i data-lucide="database" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button onclick="exportData()" class="btn py-3"
                style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="download" class="w-4 h-4"></i>
                  <span data-i18n="exportData">Ø­ÙØ¸ Ù†Ø³Ø®Ø©</span>
                </div>
              </button>

              <label class="btn py-3 cursor-pointer"
                style="background: color-mix(in srgb, #3b82f6 10%, var(--surface)); border: 1px solid color-mix(in srgb, #3b82f6 18%, var(--border)); color: color-mix(in srgb, #3b82f6 92%, var(--fg));">
                <input id="import-file" type="file" accept="application/json" class="hidden"
                  onchange="importData(event)" />
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="upload" class="w-4 h-4"></i>
                  <span data-i18n="importData">Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
                </div>
              </label>

              <button
                onclick="console.log('ğŸŸ¢ Clear Data button clicked!'); openConfirm({title: t('clearData'), message: t('deleteWarning'), confirmText: t('yesDelete'), danger: true, onConfirm: clearAllData})"
                class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border)); color: color-mix(in srgb, var(--danger) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                  <span data-i18n="clearData">Ù…Ø³Ø­ ÙƒÙ„Ø´ÙŠ</span>
                </div>
              </button>
            </div>
          </div>

          <div class="mt-6 text-center text-xs font-bold" style="color: var(--muted);">
            <div class="mb-1">TIJARATI â€” v3 <span class="font-latin">offline</span></div>
            <div class="opacity-80">
              Created by <button onclick="API.openExternal('https://portfolio-v2-eight-lovat.vercel.app/en')"
                class="font-black underline decoration-2 decoration-teal-500/50 hover:decoration-teal-500 text-teal-600">OUSSAMA</button>
            </div>
          </div>
        </div>
      </section>

    </div>

    <!-- Bottom navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-40 nav-safe-bottom px-5 pt-2 pb-3"
      style="background: color-mix(in srgb, var(--bg) 55%, transparent); backdrop-filter: blur(14px); border-top: 1px solid color-mix(in srgb, var(--border) 75%, transparent);">
      <div class="grid grid-cols-5 items-end gap-2">
        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="home-screen"
          onclick="showScreen('home-screen')" aria-label="Home">
          <i data-lucide="home" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="history-screen"
          onclick="showScreen('history-screen')" aria-label="History">
          <i data-lucide="list" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="history">Ø§Ù„Ø³Ø¬Ù„</span>
        </button>

        <div class="flex justify-center">
          <button onclick="openQuickAdd()" class="btn w-14 h-14 rounded-2xl text-white flex items-center justify-center"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); box-shadow: 0 18px 50px rgba(20,184,166,0.30); border: 1px solid color-mix(in srgb, var(--primary-2) 25%, transparent);"
            aria-label="Add">
            <i data-lucide="plus" class="w-7 h-7"></i>
          </button>
        </div>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="debts-screen"
          onclick="showScreen('debts-screen')" aria-label="Debts">
          <i data-lucide="book-open" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="credit">Ø§Ù„ÙƒØ±ÙŠØ¯ÙŠ</span>
        </button>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="partners-screen"
          onclick="showScreen('partners-screen')" aria-label="Partners">
          <i data-lucide="users" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="partners">Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</span>
        </button>
      </div>
    </nav>

    <!-- Quick Add sheet -->
    <div id="quick-add" class="fixed inset-0 z-[75] hidden items-end justify-center p-4"
      style="background: rgba(0,0,0,0.45); backdrop-filter: blur(8px);">
      <div class="w-full max-w-md card p-4 animate-pop" style="border-radius: 26px;">
        <div class="flex items-center justify-between">
          <div class="text-base font-black" data-i18n="quickAdd">Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</div>
          <button onclick="closeQuickAdd()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button onclick="startFlow('sale'); closeQuickAdd();" class="btn py-4 text-white"
            style="background: linear-gradient(135deg, color-mix(in srgb, var(--success) 75%, var(--primary-2)), var(--primary));">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="shopping-cart" class="w-5 h-5"></i>
              <span data-i18n="newSale">Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯</span>
            </div>
          </button>
          <button onclick="startFlow('purchase'); closeQuickAdd();" class="btn py-4"
            style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="package-plus" class="w-5 h-5" style="color: var(--warn);"></i>
              <span data-i18n="newPurchase">Ø´Ø±Ø§Ø¡ Ø³Ù„Ø¹Ø©</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Transaction modal -->
    <div id="transaction-modal" class="fixed inset-0 z-[90] hidden items-end sm:items-center justify-center p-0 sm:p-4"
      style="background: rgba(0,0,0,0.50); backdrop-filter: blur(10px);">
      <div class="w-full max-w-md card animate-pop overflow-hidden" style="border-radius: 26px;">
        <div id="modal-header" class="p-4 text-white"
          style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs font-extrabold text-white/75" data-i18n="transaction">Ø¹Ù…Ù„ÙŠØ©</div>
              <div id="modal-title" class="text-lg font-black">ØªØ³Ø¬ÙŠÙ„</div>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: rgba(255,255,255,0.16); border: 1px solid rgba(255,255,255,0.18);" aria-label="Close">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs font-extrabold text-white/80" data-i18n="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
            <div class="text-2xl font-black"><span id="tx-total-preview">0</span> <span
                class="text-sm currency-symbol">DH</span></div>
          </div>
        </div>

        <div class="p-5 space-y-5 max-h-[70vh] overflow-y-auto">
          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="itemName">Ø§Ø³Ù…
              Ø§Ù„Ø³Ù„Ø¹Ø©</label>
            <input id="tx-item" type="text" class="input" placeholder="â€¦" />
            <div id="quick-suggestions" class="mt-2 flex gap-2 overflow-x-auto scrollbar-hide pb-1"></div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-2">
              <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="price">Ø§Ù„Ø«Ù…Ù†
                (Ù„Ù„ÙˆØ­Ø¯Ø©)</label>
              <div class="relative">
                <input id="tx-price" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                <div class="money-currency"><span class="currency-symbol">DH</span></div>
              </div>
            </div>
            <div>
              <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
                data-i18n="quantity">Ø§Ù„Ø¹Ø¯Ø¯</label>
              <input id="tx-qty" type="number" inputmode="numeric" class="input text-center" value="1" min="1" />
            </div>
          </div>

          <div class="rounded-2xl p-4" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="paymentStatus">Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø§Øµ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="paymentHint">Ø®Ø§Ù„Øµ Ø£Ùˆ ÙƒØ±ÙŠØ¯ÙŠ</div>
              </div>
              <div class="flex rounded-2xl p-1" style="background: var(--surface); border: 1px solid var(--border);">
                <button id="btn-paid" onclick="setPaymentType('paid')"
                  class="px-3 py-1.5 rounded-xl text-xs font-black" data-i18n="paidLabel">Ø®Ø§Ù„Øµ</button>
                <button id="btn-credit" onclick="setPaymentType('credit')"
                  class="px-3 py-1.5 rounded-xl text-xs font-black" style="color: var(--muted);" data-i18n="creditLabel">ÙƒØ±ÙŠØ¯ÙŠ</button>
              </div>
            </div>

            <div id="credit-details" class="hidden mt-4 space-y-3 animate-in">
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
                  data-i18n="clientName">Ø³Ù…ÙŠØ© Ø§Ù„Ø´Ø®Øµ</label>
                <input id="tx-client" type="text" class="input" placeholder="â€¦" />
              </div>
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
                  data-i18n="amountPaid">Ø´Ø­Ø§Ù„ Ø¹Ø·Ù‰ (Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†)</label>
                <div class="relative">
                  <input id="tx-paid-amount" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                  <div class="money-currency"><span class="currency-symbol">DH</span></div>
                </div>
              </div>

              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="debtDueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒÙŠØ±</label>
                <input id="tx-due-date" type="date" class="input" />
                <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);" data-i18n="debtDueHint">Ø®Ù„ÙŠÙ‡Ø§ Ø®Ø§ÙˆÙŠØ© Ø¥Ù„Ø§ Ù…Ø§ Ø¨ØºÙŠØªÙŠØ´ ØªØ°ÙƒÙŠØ±</div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
              data-i18n="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="tx-date" type="date" class="input" />
          </div>
        </div>

        <div class="p-4"
          style="background: color-mix(in srgb, var(--surface) 90%, transparent); border-top: 1px solid var(--border);">
          <button id="save-btn" onclick="saveTransaction()" class="btn w-full py-4 text-white"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); box-shadow: 0 18px 50px rgba(20,184,166,0.25);">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="check" class="w-5 h-5"></i>
              <span data-i18n="save">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm modal (generic) -->
    <div id="confirm-modal" class="fixed inset-0 z-[95] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);">
      <div class="w-full max-w-sm card p-5 animate-pop" style="border-radius: 26px;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="confirm-title" class="text-lg font-black">ØªØ£ÙƒÙŠØ¯</div>
            <div id="confirm-message" class="mt-1 text-sm font-bold" style="color: var(--muted);"></div>
          </div>
          <button onclick="closeConfirm()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button onclick="closeConfirm()" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="confirm-action" class="btn py-3 text-white"
            style="background: linear-gradient(135deg, var(--danger), color-mix(in srgb, var(--danger) 70%, #7f1d1d));">Ø­Ø°Ù</button>
        </div>
      </div>
    </div>

    <!-- Debt details modal -->
    <div id="debt-details-modal" class="fixed inset-0 z-[94] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);">
      <div class="w-full max-w-md card p-5 animate-pop" style="border-radius: 26px;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="debtDetailsTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†</div>
          </div>
          <button onclick="closeDebtDetails()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="clientName">Ø´ÙƒÙˆÙ†ØŸ (Ø§Ù„Ø³Ù…ÙŠØ©)</div>
            <div id="debt-details-client" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="itemName">Ø´Ù†Ùˆ Ù‡Ø§Ø¯ Ø§Ù„Ø³Ù„Ø¹Ø©ØŸ</div>
            <div id="debt-details-item" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtTypeLabel">Ø§Ù„Ù†ÙˆØ¹</div>
            <div id="debt-details-type" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
            <div id="debt-details-date" class="text-sm font-black text-right truncate"></div>
          </div>

          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
              <div id="debt-details-total" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="amountPaid">Ø´Ø­Ø§Ù„ Ø¹Ø·Ù‰ Ø¯Ø§Ø¨Ø§ØŸ</div>
              <div id="debt-details-paid" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="remaining">Ø§Ù„Ø¨Ø§Ù‚ÙŠ</div>
              <div id="debt-details-remaining" class="mt-1 text-sm font-black" style="color: var(--warn);"></div>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtDueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒÙŠØ±</div>
            <div id="debt-details-reminder" class="text-sm font-black text-right truncate"></div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="debt-details-set-reminder" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="reminderSet">Ø­Ø¯Ø¯ ØªØ°ÙƒÙŠØ±</button>
          <button id="debt-details-clear-reminder" class="btn py-3 hidden"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" data-i18n="reminderClear">Ø­ÙŠØ¯ Ø§Ù„ØªØ°ÙƒÙŠØ±</button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button onclick="closeDebtDetails()" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="debt-details-settle" class="btn py-3 text-white"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2));" data-i18n="settled">ØªØ®Ù„ØµØª</button>
        </div>
      </div>
    </div>

    <!-- Transaction details modal -->
    <div id="transaction-details-modal" class="fixed inset-0 z-[93] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);">
      <div class="w-full max-w-md card p-5 animate-pop" style="border-radius: 26px;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="transactionDetailsTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          </div>
          <button onclick="closeTransactionDetails()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="itemName">Ø´Ù†Ùˆ Ù‡Ø§Ø¯ Ø§Ù„Ø³Ù„Ø¹Ø©ØŸ</div>
            <div id="txd-item" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtTypeLabel">Ø§Ù„Ù†ÙˆØ¹</div>
            <div id="txd-type" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
            <div id="txd-date" class="text-sm font-black text-right truncate"></div>
          </div>
          <div id="txd-client-row" class="flex items-center justify-between gap-3 hidden">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="clientName">Ø´ÙƒÙˆÙ†ØŸ (Ø§Ù„Ø³Ù…ÙŠØ©)</div>
            <div id="txd-client" class="text-sm font-black text-right truncate"></div>
          </div>

          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="quantity">Ø§Ù„Ø¹Ø¯Ø¯</div>
              <div id="txd-qty" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="price">Ø§Ù„Ø«Ù…Ù† (Ù„Ù„ÙˆØ­Ø¯Ø©)</div>
              <div id="txd-unit" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border));">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="total">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
              <div id="txd-total" class="mt-1 text-sm font-black" style="color: var(--primary-2);"></div>
            </div>
          </div>

          <div id="txd-credit-box" class="hidden mt-2">
            <div class="grid grid-cols-2 gap-2">
              <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="amountPaid">Ø´Ø­Ø§Ù„ Ø¹Ø·Ù‰ Ø¯Ø§Ø¨Ø§ØŸ</div>
                <div id="txd-paid" class="mt-1 text-sm font-black"></div>
              </div>
              <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="remaining">Ø§Ù„Ø¨Ø§Ù‚ÙŠ</div>
                <div id="txd-remaining" class="mt-1 text-sm font-black" style="color: var(--warn);"></div>
              </div>
            </div>
            <div class="mt-2 flex items-center justify-between gap-3">
              <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtDueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒÙŠØ±</div>
              <div id="txd-reminder" class="text-sm font-black text-right truncate"></div>
            </div>
          </div>

          <div class="mt-3 p-3 rounded-2xl" style="background: color-mix(in srgb, var(--surface) 88%, transparent); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2" style="color: var(--muted);">
                <i data-lucide="receipt" class="w-4 h-4"></i>
                <div class="text-xs font-extrabold" data-i18n="receipt">ÙˆØµÙ„</div>
              </div>
            </div>
            <pre id="txd-receipt" class="mt-2 whitespace-pre-wrap text-xs font-bold" style="color: var(--fg);"></pre>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="txd-share" class="btn py-3" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i><span data-i18n="share">Ø´Ø§Ø±Ùƒ</span></div>
          </button>
          <button id="txd-download" class="btn py-3" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i><span data-i18n="download">ØªØ­Ù…ÙŠÙ„</span></div>
          </button>
        </div>

        <div id="txd-credit-actions" class="mt-2 grid grid-cols-2 gap-2 hidden">
          <button id="txd-set-reminder" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="reminderSet">Ø­Ø¯Ø¯ ØªØ°ÙƒÙŠØ±</button>
          <button id="txd-clear-reminder" class="btn py-3 hidden"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" data-i18n="reminderClear">Ø­ÙŠØ¯ Ø§Ù„ØªØ°ÙƒÙŠØ±</button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button id="txd-delete" class="btn py-3"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));">
            <div class="flex items-center justify-center gap-2" style="color: color-mix(in srgb, var(--danger) 90%, var(--fg));">
              <i data-lucide="trash" class="w-4 h-4"></i>
              <span data-i18n="delete">Ø­Ø°Ù</span>
            </div>
          </button>
          <button id="txd-settle" class="btn py-3 text-white hidden" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));" data-i18n="settled">ØªØ®Ù„ØµØª</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast"
      class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] opacity-0 -translate-y-6 transition-all duration-200">
      <div class="px-4 py-3 rounded-2xl flex items-center gap-3"
        style="background: color-mix(in srgb, var(--fg) 92%, #000); color: var(--bg); box-shadow: var(--shadow);">
        <span id="toast-icon" style="color: var(--success);"></span>
        <div id="toast-message" class="text-sm font-black">â€¦</div>
      </div>
    </div>

    <!-- Hidden debt reminder date picker -->
    <input id="debt-reminder-picker" type="date" class="hidden" />

  </div>

  <script>
    // Make the app resilient when CDN scripts (lucide/tailwind) are unavailable in mobile WebView.
    // If lucide fails to load, we still want the app to boot and remove the loader.
    window.lucide = window.lucide || { createIcons: () => {} };

    // ==========================
    // Native Bridge
    // ==========================
    const API = {
      fetch: async (endpoint, options = {}) => {
        if (window.isNativeApp) {
          return API.bridgeCall(endpoint, options);
        }
        return null;
      },
      bridgeCall: (endpoint, options) => {
        return new Promise((resolve) => {
          const id = Date.now() + Math.random().toString();
          let type = '';
          let payload = null;

          if (endpoint === '/transactions' && options.method === 'POST') {
            type = 'SAVE_TRANSACTION';
            payload = JSON.parse(options.body);
          } else if (endpoint === '/transactions') {
            type = 'GET_TRANSACTIONS';
          } else if (endpoint === '/partners' && options.method === 'POST') {
            type = 'SAVE_PARTNER';
            payload = JSON.parse(options.body);
          } else if (endpoint === '/partners') {
            type = 'GET_PARTNERS';
          } else if (endpoint.startsWith('/partners/') && options.method === 'DELETE') {
            type = 'DELETE_PARTNER';
            const parts = endpoint.split('/');
            payload = { id: parts[parts.length - 1] };
          } else if (endpoint.startsWith('/transactions/') && options.method === 'DELETE') {
            type = 'DELETE_TRANSACTION';
            const parts = endpoint.split('/');
            payload = { id: parts[parts.length - 1] };
          } else if (endpoint === '/debt-reminders' && options.method === 'POST') {
            type = 'SCHEDULE_DEBT_REMINDER';
            payload = JSON.parse(options.body);
          } else if (endpoint.startsWith('/debt-reminders/') && options.method === 'DELETE') {
            type = 'CANCEL_DEBT_REMINDER';
            const parts = endpoint.split('/');
            payload = { id: decodeURIComponent(parts[parts.length - 1]) };
          } else if (endpoint === '/clear-all' && options.method === 'POST') {
            type = 'CLEAR_ALL_DATA';
            payload = null;
          }

          const handler = (event) => {
            let data = event.data;
            try {
              if (typeof data === 'string') data = JSON.parse(data);
            } catch (e) { }

            if (data && data.id === id) {
              document.removeEventListener('message', handler);
              window.removeEventListener('message', handler);
              resolve(data.result);
            }
          };

          document.addEventListener('message', handler);
          window.addEventListener('message', handler);

          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type, payload }));
          }
        });
      },
      init: () => {
        const backHandler = (event) => {
          try {
            let data = event.data;
            if (typeof data === 'string') data = JSON.parse(data);
            if (data.type === 'GO_BACK') {
              handleBack();
            } else if (data.type === 'THEME_CHANGED') {
              window.systemTheme = data.payload;
              if (state.theme === 'system') applyTheme();
            }
          } catch (e) { }
        };
        document.addEventListener('message', backHandler);
        window.addEventListener('message', backHandler);
      },
      getTransactions: () => API.fetch('/transactions'),
      saveTransaction: (tx) => API.fetch('/transactions', { method: 'POST', body: JSON.stringify(tx) }),
      getPartners: () => API.fetch('/partners'),
      savePartner: (p) => API.fetch('/partners', { method: 'POST', body: JSON.stringify(p) }),
      deletePartner: (id) => API.fetch('/partners/' + id, { method: 'DELETE' }),
      deleteTransaction: (id) => API.fetch('/transactions/' + id, { method: 'DELETE' }),
      scheduleDebtReminder: (data) => API.fetch('/debt-reminders', { method: 'POST', body: JSON.stringify(data) }),
      cancelDebtReminder: (id) => API.fetch('/debt-reminders/' + encodeURIComponent(String(id)), { method: 'DELETE' }),
      clearAllData: () => API.fetch('/clear-all', { method: 'POST' }),
      openExternal: (url) => {
        if (window.isNativeApp && window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'OPEN_EXTERNAL', payload: { url } }));
        } else {
          window.open(url, '_blank');
        }
      },
      saveFile: (fileName, content) => {
        return API.saveFileWithType(fileName, content, null);
      },
      saveFileWithType: (fileName, content, mimeType) => {
        return new Promise((resolve) => {
          if (window.isNativeApp && window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
                resolve(data.result);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'SAVE_FILE', payload: { fileName, content, mimeType } }));
          } else {
            const mt = mimeType || (String(fileName || '').toLowerCase().endsWith('.txt') ? 'text/plain' : 'application/json');
            const dataStr = 'data:' + mt + ';charset=utf-8,' + encodeURIComponent(content);
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            a.setAttribute('download', fileName);
            document.body.appendChild(a);
            a.click();
            a.remove();
            resolve({ success: true });
          }
        });
      },
      pickFile: () => {
        return new Promise((resolve) => {
          if (window.isNativeApp && window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
                resolve(data.result);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'PICK_FILE', payload: {} }));
          } else {
            resolve({ success: false });
          }
        });
      }
    };

    function handleBack() {
      if (!document.getElementById('confirm-modal').classList.contains('hidden')) { closeConfirm(); return; }
      if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) { closeDebtDetails(); return; }
      if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) { closeTransactionDetails(); return; }
      if (!document.getElementById('transaction-modal').classList.contains('hidden')) { closeModal(); return; }
      if (!document.getElementById('quick-add').classList.contains('hidden')) { closeQuickAdd(); return; }

      const settings = document.getElementById('settings-screen');
      if (settings && settings.classList.contains('active')) {
        closeSettings();
        return;
      }

      if (state.lastScreen && state.lastScreen !== 'home-screen') {
        goBack();
      } else {
        if (window.isNativeApp && window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'EXIT_APP' }));
        }
      }
    }

    // ==========================
    // State & config (v3)
    // ==========================
    const STORAGE_KEY = 'tijarati_pro_state_v3';

    let state = {
      language: 'darija',
      currency: 'MAD',
      theme: 'system', // 'light' | 'dark' | 'system'
      dashboardRange: 'today',
      transactions: [],
      partners: [],
      currentFlow: null,
      paymentType: 'paid',
      lastScreen: 'home-screen'
    };

    // Base currency: MAD (store everything internally in MAD)
    const exchangeRates = { MAD: 1, EUR: 0.092, USD: 0.099 }; // 1 MAD -> X currency
    const currencySymbols = { MAD: 'DH', EUR: 'â‚¬', USD: '$' };

    const translations = {
      darija: {
        appName: 'ØªØ¬Ø§Ø±ØªÙŠ',
        loading: 'ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦',
        clearingData: 'ÙƒØ§Ù†Ù…Ø³Ø­Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦',
        clearedDone: 'ØªÙ… Ø§Ù„Ù…Ø³Ø­!',
        clearFailed: 'ÙˆÙ‚Ø¹ Ù…Ø´ÙƒÙ„ ÙØ§Ù„Ù…Ø³Ø­',
        home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        history: 'Ø§Ù„Ø³Ø¬Ù„',
        credit: 'Ø§Ù„ÙƒØ±ÙŠØ¯ÙŠ',
        partners: 'Ø§Ù„Ø´Ø±ÙƒØ§Ø¡',
        settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        appearance: 'Ø§Ù„Ù…Ø¸Ù‡Ø±',
        appearanceHint: 'Light / Dark',
        language: 'Ø§Ù„Ù„ØºØ©',
        languageHint: 'Ø¨Ø¯Ù‘Ù„ Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©',
        currency: 'Ø§Ù„Ø¹Ù…Ù„Ø©',
        currencyHint: 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙŠÙƒÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ',
        data: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        dataHint: 'ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­',
        exportData: 'Ø­ÙØ¸ Ù†Ø³Ø®Ø©',
        importData: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯',
        clearData: 'Ù…Ø³Ø­ ÙƒÙ„Ø´ÙŠ',
        yesDelete: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­',
        delete: 'Ø­Ø°Ù',
        cancel: 'Ù„Ø§ØŒ Ø±Ø¬Ø¹',
        income: 'ÙÙ„ÙˆØ³ Ø¯Ø®Ù„Ùˆ',
        expenses: 'ÙÙ„ÙˆØ³ Ø®Ø±Ø¬Ùˆ',
        netProfit: 'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ',
        cashFlow: 'ØªØ¯ÙÙ‚ Ù†Ù‚Ø¯ÙŠ',
        today: 'Ø§Ù„ÙŠÙˆÙ…',
        allTime: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        quickActions: 'Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©',
        tips: 'Ù†ØµÙŠØ­Ø©: Ø§Ø¶ØºØ· (+) Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©',
        newSale: 'Ø¨Ø¹Øª Ø³Ù„Ø¹Ø©',
        newPurchase: 'Ø´Ø±ÙŠØª Ø³Ù„Ø¹Ø©',
        saleHint: 'Ø¯Ø®Ù„ ÙÙ„ÙˆØ³',
        purchaseHint: 'Ø®Ø±Ø¬ ÙÙ„ÙˆØ³',
        pendingDebts: 'ÙÙ„ÙˆØ³Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø§Ø³',
        recentActivity: 'Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¯ÙŠØ§Ù„Ùƒ',
        seeAll: 'Ø´ÙˆÙ Ø§Ù„ÙƒÙ„',
        transactions: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
        transaction: 'Ø¹Ù…Ù„ÙŠØ©',
        total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
        itemName: 'Ø´Ù†Ùˆ Ù‡Ø§Ø¯ Ø§Ù„Ø³Ù„Ø¹Ø©ØŸ',
        price: 'Ø§Ù„Ø«Ù…Ù† (Ù„Ù„ÙˆØ­Ø¯Ø©)',
        quantity: 'Ø§Ù„Ø¹Ø¯Ø¯',
        paymentStatus: 'ÙˆØ§Ø´ ØªØ®Ù„ØµØªÙŠØŸ',
        paymentHint: 'Ø®Ø§Ù„Øµ Ø£Ùˆ ÙƒØ±ÙŠØ¯ÙŠ',
        paidLabel: 'Ø®Ø§Ù„Øµ',
        creditLabel: 'ÙƒØ±ÙŠØ¯ÙŠ',
        paidShort: 'Ø®Ø§Ù„Øµ',
        creditShort: 'ÙƒØ±ÙŠØ¯ÙŠ',
        clientName: 'Ø´ÙƒÙˆÙ†ØŸ (Ø§Ù„Ø³Ù…ÙŠØ©)',
        amountPaid: 'Ø´Ø­Ø§Ù„ Ø¹Ø·Ù‰ Ø¯Ø§Ø¨Ø§ØŸ',
        remaining: 'Ø§Ù„Ø¨Ø§Ù‚ÙŠ',
        settled: 'ØªØ®Ù„ØµØª',
        debtDueDate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒÙŠØ±',
        debtDueHint: 'Ø®Ù„ÙŠÙ‡Ø§ Ø®Ø§ÙˆÙŠØ© Ø¥Ù„Ø§ Ù…Ø§ Ø¨ØºÙŠØªÙŠØ´ ØªØ°ÙƒÙŠØ±',
        reminderSet: 'Ø­Ø¯Ø¯ ØªØ°ÙƒÙŠØ±',
        reminderClear: 'Ø­ÙŠØ¯ Ø§Ù„ØªØ°ÙƒÙŠØ±',
        noReminder: 'Ø¨Ù„Ø§ ØªØ°ÙƒÙŠØ±',
        date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
        save: 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        quickAdd: 'Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©',
        refresh: 'ØªØ­Ø¯ÙŠØ«',
        creditBook: 'Ø¯ÙØªØ± Ø§Ù„ÙƒØ±ÙŠØ¯ÙŠ',
        peopleOweYou: 'Ù†Ø§Ø³ ÙƒÙŠØªØ³Ø§Ù„ÙˆÙƒ Ø£Ùˆ Ù†ØªØ§ ÙƒØ§ØªØ³Ø§Ù„ÙŠÙ‡Ù…',
        stock: 'Ø§Ù„Ø³Ù„Ø¹Ø©',
        addPartner: 'Ø²ÙŠØ¯ Ø´Ø±ÙŠÙƒ',
        partnerHint: 'Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø±Ø¨Ø­',
        add: 'Ø¥Ø¶Ø§ÙØ©',
        deleteWarning: 'ØºØ§Ø¯ÙŠ ÙŠÙ…Ø´ÙŠ ÙƒÙ„Ø´ÙŠ!',
        confirmTitle: 'ØªØ£ÙƒÙŠØ¯',
        confirmAction: 'Ù†Ø¹Ù…',
        settleDebtConfirmMessage: 'Ù†Ù’Ø³Ø¬Ù„Ùˆ Ù‡Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙ† Ø¨Ù„ÙŠ ØªÙ’Ø®Ù„Ù‘ØµØŸ',
        debtDetailsTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†',
        debtTypeLabel: 'Ø§Ù„Ù†ÙˆØ¹',
        transactionDetailsTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        receipt: 'ÙˆØµÙ„',
        share: 'Ø´Ø§Ø±Ùƒ',
        download: 'ØªØ­Ù…ÙŠÙ„',
        deleteTransactionTitle: 'Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        deleted: 'ØªØ­ÙŠØ¯Ø§Øª',
        search: 'Ø¨Ø­Ø«â€¦',
        searchDebts: 'Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ù„Ø¹Ø©â€¦',
        filterAll: 'Ø§Ù„ÙƒÙ„',
        filterSales: 'Ø¨ÙŠØ¹',
        filterPurchases: 'Ø´Ø±Ø§',
        filterCredits: 'ÙƒØ±ÙŠØ¯ÙŠ',
        emptyToday: 'Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ Ø¯Ø±ØªÙŠ ÙˆØ§Ù„Ùˆ.',
        emptyHistory: 'Ù…Ø§ ÙƒØ§ÙŠÙ†Ø§Ø´ Ø¹Ù…Ù„ÙŠØ§Øª Ø­ØªÙ‰ Ø¯Ø§Ø¨Ø§.',
        emptyDebts: 'Ù…Ø§ ÙƒØ§ÙŠÙ† Ø­ØªÙ‰ Ø¯ÙŠÙ† Ù…Ø¹Ù„Ù‚.',
        copied: 'ØªÙ†Ø³Ø® Ø§Ù„ÙˆØµÙ„!',
        saved: 'ØªØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
        fillAll: 'Ø¹Ù…Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø© Ø¹Ø§ÙØ§Ùƒ',
        needClient: 'ÙƒØªØ¨ Ø³Ù…ÙŠØ© Ø§Ù„Ø³ÙŠØ¯ Ù„ÙŠ Ø®Ø¯Ø§ Ø§Ù„ÙƒØ±ÙŠØ¯ÙŠ'
      },
      arabic: {
        appName: 'ØªØ¬Ø§Ø±ØªÙŠ',
        loading: 'ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦',
        clearingData: 'Ø¬Ø§Ø±Ù Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦',
        clearedDone: 'ØªÙ… Ø§Ù„Ù…Ø³Ø­!',
        clearFailed: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­',
        home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        history: 'Ø§Ù„Ø³Ø¬Ù„',
        credit: 'Ø§Ù„Ø¯ÙŠÙˆÙ†',
        partners: 'Ø§Ù„Ø´Ø±ÙƒØ§Ø¡',
        settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        appearance: 'Ø§Ù„Ù…Ø¸Ù‡Ø±',
        appearanceHint: 'ÙØ§ØªØ­ / Ø¯Ø§ÙƒÙ†',
        language: 'Ø§Ù„Ù„ØºØ©',
        languageHint: 'ØªØºÙŠÙŠØ± Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©',
        currency: 'Ø§Ù„Ø¹Ù…Ù„Ø©',
        currencyHint: 'ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
        data: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        dataHint: 'ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ Ù…Ø³Ø­',
        exportData: 'ØªØµØ¯ÙŠØ±',
        importData: 'Ø§Ø³ØªÙŠØ±Ø§Ø¯',
        clearData: 'Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        yesDelete: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        delete: 'Ø­Ø°Ù',
        cancel: 'Ø¥Ù„ØºØ§Ø¡',
        income: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
        expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
        netProfit: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­',
        cashFlow: 'ØªØ¯ÙÙ‚ Ù†Ù‚Ø¯ÙŠ',
        today: 'Ø§Ù„ÙŠÙˆÙ…',
        allTime: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        quickActions: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©',
        tips: 'Ù†ØµÙŠØ­Ø©: Ø§Ø¶ØºØ· (+) Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©',
        newSale: 'Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯',
        newPurchase: 'Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯',
        saleHint: 'Ø¥ÙŠØ±Ø§Ø¯',
        purchaseHint: 'Ù…ØµØ±ÙˆÙ',
        pendingDebts: 'Ø¯ÙŠÙˆÙ† Ù…Ø¹Ù„Ù‚Ø©',
        recentActivity: 'Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±',
        seeAll: 'Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„',
        transactions: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
        transaction: 'Ø¹Ù…Ù„ÙŠØ©',
        total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
        itemName: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù',
        price: 'Ø§Ù„Ø³Ø¹Ø± (Ù„Ù„ÙˆØ­Ø¯Ø©)',
        quantity: 'Ø§Ù„ÙƒÙ…ÙŠØ©',
        paymentStatus: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹',
        paymentHint: 'Ù…Ø¯ÙÙˆØ¹ Ø£Ùˆ Ø¯ÙŠÙ†',
        paidLabel: 'Ø®Ø§Ù„Øµ',
        creditLabel: 'ÙƒØ±ÙŠØ¯ÙŠ',
        paidShort: 'Ù…Ø¯ÙÙˆØ¹',
        creditShort: 'Ø¯ÙŠÙ†',
        clientName: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
        amountPaid: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹',
        remaining: 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',
        settled: 'ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯',
        debtDueDate: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ°ÙƒÙŠØ±',
        debtDueHint: 'Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ø§ ØªØ±ÙŠØ¯ ØªØ°ÙƒÙŠØ±Ø§Ù‹',
        reminderSet: 'ØªØ­Ø¯ÙŠØ¯ ØªØ°ÙƒÙŠØ±',
        reminderClear: 'Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒÙŠØ±',
        noReminder: 'Ø¨Ø¯ÙˆÙ† ØªØ°ÙƒÙŠØ±',
        date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
        save: 'Ø­ÙØ¸',
        quickAdd: 'Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©',
        refresh: 'ØªØ­Ø¯ÙŠØ«',
        creditBook: 'Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†',
        peopleOweYou: 'Ø§Ù†Ø§Ø³ Ù…Ø¯ÙŠÙ†ÙˆÙ† Ù„Ùƒ Ø£Ùˆ Ø£Ù†Øª Ù…Ø¯ÙŠÙ† Ù„Ù‡Ù…',
        stock: 'Ø§Ù„Ø³Ù„Ø¹Ø©',
        addPartner: 'Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠÙƒ',
        partnerHint: 'Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø¨Ø§Ø­',
        add: 'Ø¥Ø¶Ø§ÙØ©',
        deleteWarning: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        confirmTitle: 'ØªØ£ÙƒÙŠØ¯',
        confirmAction: 'ØªØ£ÙƒÙŠØ¯',
        settleDebtConfirmMessage: 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙŠÙ† ÙƒÙ…ÙØ³Ø¯Ù‘ÙØ¯ØŸ',
        debtDetailsTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†',
        debtTypeLabel: 'Ø§Ù„Ù†ÙˆØ¹',
        transactionDetailsTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        receipt: 'Ø¥ÙŠØµØ§Ù„',
        share: 'Ù…Ø´Ø§Ø±ÙƒØ©',
        download: 'ØªØ­Ù…ÙŠÙ„',
        deleteTransactionTitle: 'Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
        deleted: 'ØªÙ… Ø§Ù„Ø­Ø°Ù',
        search: 'Ø¨Ø­Ø«â€¦',
        searchDebts: 'Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ù„Ø¹Ø©â€¦',
        filterAll: 'Ø§Ù„ÙƒÙ„',
        filterSales: 'Ù…Ø¨ÙŠØ¹Ø§Øª',
        filterPurchases: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
        filterCredits: 'Ø¯ÙŠÙˆÙ†',
        emptyToday: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.',
        emptyHistory: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª.',
        emptyDebts: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø¹Ù„Ù‘Ù‚Ø©.',
        copied: 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙˆØµÙ„!',
        saved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
        fillAll: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø©',
        needClient: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'
      },
      french: {
        appName: 'TIJARATI',
        loading: 'Chargementâ€¦',
        clearingData: 'Suppression des donnÃ©esâ€¦',
        clearedDone: 'TerminÃ© !',
        clearFailed: 'Ã‰chec de la suppression',
        home: 'Accueil',
        history: 'Historique',
        credit: 'CrÃ©dits',
        partners: 'Partenaires',
        settings: 'ParamÃ¨tres',
        appearance: 'Apparence',
        appearanceHint: 'Clair / Sombre',
        language: 'Langue',
        languageHint: "Changer la langue de l'interface",
        currency: 'Devise',
        currencyHint: 'Conversion automatique',
        data: 'DonnÃ©es',
        dataHint: 'Exporter/Importer/Supprimer',
        exportData: 'Exporter',
        importData: 'Importer',
        clearData: 'Tout effacer',
        yesDelete: 'Oui, supprimer',
        delete: 'Supprimer',
        cancel: 'Annuler',
        income: 'EntrÃ©es',
        expenses: 'Sorties',
        netProfit: 'BÃ©nÃ©fice net',
        cashFlow: 'Cash flow',
        today: "Aujourd'hui",
        allTime: 'Total',
        quickActions: 'Actions rapides',
        tips: 'Astuce : bouton (+) pour ajouter vite',
        newSale: 'Nouvelle vente',
        newPurchase: 'Nouvel achat',
        saleHint: 'EntrÃ©e',
        purchaseHint: 'Sortie',
        pendingDebts: 'CrÃ©dits en cours',
        recentActivity: 'ActivitÃ© rÃ©cente',
        seeAll: 'Voir tout',
        transactions: 'Transactions',
        transaction: 'Transaction',
        total: 'Total',
        itemName: 'Article',
        price: 'Prix (unitÃ©)',
        quantity: 'QuantitÃ©',
        paymentStatus: 'Paiement',
        paymentHint: 'PayÃ© ou crÃ©dit',
        paidLabel: 'PayÃ©',
        creditLabel: 'CrÃ©dit',
        paidShort: 'PayÃ©',
        creditShort: 'CrÃ©dit',
        clientName: 'Client',
        amountPaid: 'Montant payÃ©',
        remaining: 'Restant',
        settled: 'RÃ©glÃ©',
        debtDueDate: 'Date rappel',
        debtDueHint: 'Laissez vide si pas de rappel',
        reminderSet: 'DÃ©finir rappel',
        reminderClear: 'Supprimer rappel',
        noReminder: 'Pas de rappel',
        date: 'Date',
        save: 'Enregistrer',
        quickAdd: 'Ajout rapide',
        refresh: 'RafraÃ®chir',
        creditBook: 'Carnet de crÃ©dit',
        peopleOweYou: 'Les gens vous doivent ou vous leur devez',
        stock: 'Stock',
        addPartner: 'Ajouter partenaire',
        partnerHint: 'Pourcentage du bÃ©nÃ©fice',
        add: 'Ajouter',
        deleteWarning: 'Toutes les donnÃ©es seront supprimÃ©es',
        confirmTitle: 'Confirmation',
        confirmAction: 'Confirmer',
        settleDebtConfirmMessage: 'Marquer cette dette comme rÃ©glÃ©e ?',
        debtDetailsTitle: 'DÃ©tails de la dette',
        debtTypeLabel: 'Type',
        transactionDetailsTitle: 'DÃ©tails de la transaction',
        receipt: 'ReÃ§u',
        share: 'Partager',
        download: 'TÃ©lÃ©charger',
        deleteTransactionTitle: 'Supprimer la transaction',
        deleted: 'SupprimÃ©',
        search: 'Rechercherâ€¦',
        searchDebts: 'Rechercher par nom ou articleâ€¦',
        filterAll: 'Tout',
        filterSales: 'Ventes',
        filterPurchases: 'Achats',
        filterCredits: 'CrÃ©dits',
        emptyToday: "Aucune opÃ©ration pour l'instant.",
        emptyHistory: 'Aucune transaction.',
        emptyDebts: "Aucun crÃ©dit en cours.",
        copied: 'ReÃ§u copiÃ© !',
        saved: 'Transaction enregistrÃ©e !',
        fillAll: 'Veuillez remplir tous les champs',
        needClient: 'Veuillez saisir le nom du client'
      },
      english: {
        appName: 'TIJARATI',
        loading: 'Preparingâ€¦',
        clearingData: 'Clearing dataâ€¦',
        clearedDone: 'Done!',
        clearFailed: 'Clear failed',
        home: 'Home',
        history: 'History',
        credit: 'Debts',
        partners: 'Partners',
        settings: 'Settings',
        appearance: 'Appearance',
        appearanceHint: 'Light / Dark',
        language: 'Language',
        languageHint: 'Change UI language',
        currency: 'Currency',
        currencyHint: 'Auto conversion',
        data: 'Data',
        dataHint: 'Export/Import/Clear',
        exportData: 'Export',
        importData: 'Import',
        clearData: 'Clear data',
        yesDelete: 'Yes, delete',
        delete: 'Delete',
        cancel: 'Cancel',
        income: 'Income',
        expenses: 'Expenses',
        netProfit: 'Net profit',
        cashFlow: 'Cash flow',
        today: 'Today',
        allTime: 'All time',
        quickActions: 'Quick actions',
        tips: 'Tip: use (+) to add quickly',
        newSale: 'New sale',
        newPurchase: 'New purchase',
        saleHint: 'Cash in',
        purchaseHint: 'Cash out',
        pendingDebts: 'Pending debts',
        recentActivity: 'Recent activity',
        seeAll: 'See all',
        transactions: 'Transactions',
        transaction: 'Transaction',
        total: 'Total',
        itemName: 'Item name',
        price: 'Unit price',
        quantity: 'Quantity',
        paymentStatus: 'Payment',
        paymentHint: 'Paid or credit',
        paidLabel: 'Paid',
        creditLabel: 'Credit',
        paidShort: 'Paid',
        creditShort: 'Credit',
        clientName: 'Client name',
        amountPaid: 'Amount paid',
        remaining: 'Remaining',
        settled: 'Settled',
        debtDueDate: 'Reminder date',
        debtDueHint: 'Leave empty if you do not want a reminder',
        reminderSet: 'Set reminder',
        reminderClear: 'Clear reminder',
        noReminder: 'No reminder',
        date: 'Date',
        save: 'Save',
        quickAdd: 'Quick add',
        refresh: 'Refresh',
        creditBook: 'Debt book',
        peopleOweYou: 'People Owe You OR you owe them',
        stock: 'Stock',
        addPartner: 'Add partner',
        partnerHint: 'Profit percentage',
        add: 'Add',
        deleteWarning: 'All data will be deleted',
        confirmTitle: 'Confirm',
        confirmAction: 'Confirm',
        settleDebtConfirmMessage: 'Mark this debt as settled?',
        debtDetailsTitle: 'Debt details',
        debtTypeLabel: 'Type',
        transactionDetailsTitle: 'Transaction details',
        receipt: 'Receipt',
        share: 'Share',
        download: 'Download',
        deleteTransactionTitle: 'Delete transaction',
        deleted: 'Deleted',
        search: 'Searchâ€¦',
        searchDebts: 'Search by name or itemâ€¦',
        filterAll: 'All',
        filterSales: 'Sales',
        filterPurchases: 'Purchases',
        filterCredits: 'Debts',
        emptyToday: 'No transactions yet.',
        emptyHistory: 'No transactions.',
        emptyDebts: 'No pending debts.',
        copied: 'Receipt copied!',
        saved: 'Saved successfully!',
        fillAll: 'Please fill in all required fields',
        needClient: 'Please enter client name'
      }
    };

    // ==========================
    // Helpers
    // ==========================
    function t(key) {
      return (translations[state.language] && translations[state.language][key]) || translations.darija[key] || key;
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function baseFromCurrentCurrency(amountInSelectedCurrency) {
      const rate = exchangeRates[state.currency] || 1;
      return amountInSelectedCurrency / rate;
    }

    function formatMoney(baseAmount) {
      const rate = exchangeRates[state.currency] || 1;
      const value = baseAmount * rate;
      const locale = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar-MA');
      try {
        return new Intl.NumberFormat(locale, { maximumFractionDigits: 2 }).format(value);
      } catch {
        return (value || 0).toFixed(2);
      }
    }

    function setThemeColorMeta() {
      const meta = document.querySelector('meta[name="theme-color"]');
      const dark = document.documentElement.classList.contains('dark');
      meta && meta.setAttribute('content', dark ? '#070b16' : '#f7f7fb');
    }

    // ==========================
    // Persistence
    // ==========================
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const saved = JSON.parse(raw);
          state = { ...state, ...saved };
        } catch { /* ignore */ }
      }
      if (!Array.isArray(state.transactions)) state.transactions = [];
      if (!Array.isArray(state.partners)) state.partners = [];
      if (!state.dashboardRange) state.dashboardRange = 'today';
      if (!state.theme) state.theme = 'system';
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        language: state.language,
        currency: state.currency,
        theme: state.theme,
        dashboardRange: state.dashboardRange,
        transactions: state.transactions,
        partners: state.partners,
        lastScreen: state.lastScreen
      }));
    }

    // ==========================
    // Theme
    // ==========================
    function systemPrefersDark() {
      if (window.isNativeApp && window.systemTheme) return window.systemTheme === 'dark';
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    function applyTheme() {
      const mode = state.theme;
      const shouldDark = mode === 'dark' || (mode === 'system' && systemPrefersDark());
      document.documentElement.classList.toggle('dark', shouldDark);
      setThemeColorMeta();
      updateThemeButtons();
    }

    function cycleTheme() {
      // user-friendly: system -> dark -> light -> system
      const order = ['system', 'dark', 'light'];
      const idx = order.indexOf(state.theme);
      state.theme = order[(idx + 1) % order.length];
      saveState();
      applyTheme();
      showToast(state.theme === 'dark' ? 'Dark mode' : state.theme === 'light' ? 'Light mode' : 'System', 'info');
    }

    function themeLabel() {
      if (state.theme === 'dark') return 'Dark';
      if (state.theme === 'light') return 'Light';
      return 'System';
    }

    function updateThemeButtons() {
      const dark = document.documentElement.classList.contains('dark');
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.innerHTML = dark
          ? '<i data-lucide="sun" class="w-5 h-5"></i>'
          : '<i data-lucide="moon" class="w-5 h-5"></i>';
      }
      const btn = document.getElementById('settings-theme');
      const label = document.getElementById('settings-theme-label');
      if (btn && label) {
        label.textContent = themeLabel();
        btn.onclick = cycleTheme;
      }
      lucide.createIcons();
    }

    // ==========================
    // i18n & direction
    // ==========================
    function applyLanguage() {
      const isRTL = ['darija', 'arabic'].includes(state.language);
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      document.documentElement.lang = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar');

      // Switch font for latin-heavy languages
      document.body.style.fontFamily = isRTL ? 'var(--font-ar)' : 'var(--font-latin)';

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        el.textContent = t(key);
      });

      // Update placeholders
      const hs = document.getElementById('history-search');
      if (hs) hs.placeholder = t('search');
      const ds = document.getElementById('debts-search');
      if (ds) ds.placeholder = t('searchDebts');

      document.querySelectorAll('.lang-btn').forEach(btn => {
        const active = btn.dataset.lang === state.language;
        btn.style.borderColor = active ? 'color-mix(in srgb, var(--primary) 45%, var(--border))' : 'var(--border)';
        btn.style.background = active ? 'color-mix(in srgb, var(--primary) 10%, var(--surface))' : 'var(--surface-2)';
        btn.style.color = active ? 'var(--fg)' : 'var(--fg)';
      });

      updateDateHeader();
    }

    function setLanguage(lang) {
      state.language = lang;
      saveState();
      applyLanguage();
      renderAll();
    }

    // ==========================
    // Currency
    // ==========================
    function applyCurrency() {
      document.querySelectorAll('.currency-symbol').forEach(el => {
        el.textContent = currencySymbols[state.currency] || state.currency;
      });

      document.querySelectorAll('.curr-btn').forEach(btn => {
        const active = btn.dataset.curr === state.currency;
        btn.style.background = active ? 'linear-gradient(135deg, var(--primary), var(--primary-2))' : 'var(--surface-2)';
        btn.style.border = active ? '1px solid color-mix(in srgb, var(--primary-2) 28%, transparent)' : '1px solid var(--border)';
        btn.style.color = active ? '#fff' : 'var(--fg)';
      });
    }

    function setCurrency(curr) {
      state.currency = curr;
      saveState();
      applyCurrency();
      renderAll();
    }

    // ==========================
    // Navigation
    // ==========================
    const navStack = [];

    function showScreen(id, opts = { push: true }) {
      const current = document.querySelector('.screen.active');
      if (opts.push && current && current.id !== id && current.id !== 'settings-screen') {
        navStack.push(current.id);
      }

      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      if (screen) screen.classList.add('active');

      // Update nav active
      document.querySelectorAll('.nav-item').forEach(n => {
        const active = n.dataset.target === id;
        n.style.color = active ? 'var(--primary-2)' : 'var(--muted)';
      });

      state.lastScreen = id;
      saveState();

      // Trigger renderers
      if (id === 'home-screen') updateDashboard();
      if (id === 'history-screen') renderHistory();
      if (id === 'debts-screen') renderDebts();
      if (id === 'partners-screen') renderPartnersAndStock();

      lucide.createIcons();
    }

    function goBack() {
      const prev = navStack.pop();
      showScreen(prev || 'home-screen', { push: false });
    }

    function openSettings() {
      showScreen('settings-screen', { push: true });
    }

    function closeSettings() {
      goBack();
    }

    // ==========================
    // Dashboard
    // ==========================
    function setDashboardRange(range) {
      state.dashboardRange = range;
      saveState();
      updateDashboard();
    }

    function updateRangeUI() {
      const todayBtn = document.getElementById('range-today');
      const allBtn = document.getElementById('range-all');
      if (!todayBtn || !allBtn) return;

      const activeStyle = { background: 'var(--surface)', border: '1px solid var(--border)', color: 'var(--fg)' };
      const inactiveStyle = { background: 'transparent', border: '1px solid transparent', color: 'var(--muted)' };

      const apply = (el, st) => {
        el.style.background = st.background;
        el.style.border = st.border;
        el.style.color = st.color;
      };

      if (state.dashboardRange === 'today') {
        apply(todayBtn, activeStyle);
        apply(allBtn, inactiveStyle);
      } else {
        apply(allBtn, activeStyle);
        apply(todayBtn, inactiveStyle);
      }
    }

    function updateDashboard() {
      updateRangeUI();

      const today = new Date().toISOString().slice(0, 10);
      const scopeTx = state.dashboardRange === 'today'
        ? state.transactions.filter(t => t.date === today)
        : state.transactions;

      const incomeBase = scopeTx
        .filter(t => t.type === 'sale')
        .reduce((sum, t) => sum + (t.paidAmountBase ?? t.amountBase ?? 0), 0);

      const expenseBase = scopeTx
        .filter(t => t.type === 'purchase')
        .reduce((sum, t) => sum + (t.paidAmountBase ?? t.amountBase ?? 0), 0);

      const balanceBase = incomeBase - expenseBase;

      const balanceEl = document.getElementById('dashboard-balance');
      const incEl = document.getElementById('dashboard-income');
      const expEl = document.getElementById('dashboard-expense');

      if (balanceEl) {
        balanceEl.textContent = formatMoney(Math.abs(balanceBase));
        balanceEl.style.color = balanceBase >= 0 ? 'var(--fg)' : 'color-mix(in srgb, var(--danger) 80%, var(--fg))';
      }
      if (incEl) incEl.textContent = formatMoney(incomeBase);
      if (expEl) expEl.textContent = formatMoney(expenseBase);

      // Recent list
      const recentContainer = document.getElementById('recent-transactions-list');
      const recent = [...state.transactions].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);

      if (recentContainer) {
        if (recent.length === 0) {
          recentContainer.innerHTML = emptyState('inbox', t('emptyToday'));
        } else {
          recentContainer.innerHTML = recent.map(tx => createTransactionRow(tx, { compact: true })).join('');
        }
      }

      // Debt alert
      const totalDebt = calculateTotalPendingDebt();
      const alert = document.getElementById('debt-alert');
      if (alert) {
        if (totalDebt > 0.0001) {
          alert.classList.remove('hidden');
          document.getElementById('total-pending-debt').textContent = formatMoney(totalDebt);
        } else {
          alert.classList.add('hidden');
        }
      }

      applyCurrency();
      lucide.createIcons();
    }

    function calculateTotalPendingDebt() {
      return state.transactions
        .filter(t => t.isCredit && !t.isFullyPaid)
        .reduce((sum, t) => sum + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);
    }

    // ==========================
    // Transaction rows
    // ==========================
    function txBadgeHTML(tx) {
      if (!tx.isCredit) return '';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const done = remaining < 0.0001;
      const bg = done ? 'color-mix(in srgb, var(--success) 14%, transparent)' : 'color-mix(in srgb, var(--warn) 16%, transparent)';
      const color = done ? 'var(--success)' : 'var(--warn)';
      const label = done ? t('paidShort') : t('creditShort');
      return `<span class="px-2 py-0.5 rounded-full text-[11px] font-black" style="background: ${bg}; color: ${color}; border: 1px solid color-mix(in srgb, ${color} 20%, var(--border));">${label}</span>`;
    }

    function createTransactionRow(tx, { compact = false } = {}) {
      const isSale = tx.type === 'sale';
      const icon = isSale ? 'trending-up' : 'trending-down';
      const accent = isSale ? 'var(--success)' : 'var(--danger)';
      const bg = `color-mix(in srgb, ${accent} 12%, transparent)`;
      const border = `color-mix(in srgb, ${accent} 18%, var(--border))`;

      const amountText = formatMoney(tx.amountBase || 0);
      const meta = [tx.date, (tx.quantity && tx.quantity > 1) ? `Ã—${tx.quantity}` : null].filter(Boolean).join(' â€¢ ');
      const sub = tx.isCredit ? `${tx.clientName || ''}` : '';

      return `
        <div class="card p-4 flex items-center justify-between gap-3 animate-in cursor-pointer" onclick="openTransactionDetails(${tx.id})">
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-11 h-11 rounded-2xl flex items-center justify-center flex-none" style="background: ${bg}; border: 1px solid ${border}; color: ${accent};">
              <i data-lucide="${icon}" class="w-5 h-5"></i>
            </div>
            <div class="min-w-0">
              <div class="flex items-center gap-2 min-w-0">
                <div class="font-black truncate flex-1 min-w-0">${escapeHtml(tx.item || '')}</div>
              </div>
              <div class="mt-0.5 text-xs font-bold truncate" style="color: var(--muted);">
                ${escapeHtml(meta)}${sub ? ` â€¢ ${escapeHtml(sub)}` : ''}
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2 flex-none">
            <div class="text-left">
              <div class="font-black" style="color: ${accent};">${amountText} <span class="text-[10px] font-black currency-symbol" style="color: color-mix(in srgb, ${accent} 70%, var(--muted));"></span></div>
              ${compact ? '' : `<div class="text-xs font-bold" style="color: var(--muted);">${tx.isCredit ? (t('remaining') + ': ' + formatMoney(Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0)))) : ''}</div>`}
            </div>

            <button onclick="event.stopPropagation(); openTransactionDetails(${tx.id}, 'receipt')" class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Receipt">
              <i data-lucide="receipt" class="w-4 h-4" style="color: var(--muted);"></i>
            </button>

            <button onclick="event.stopPropagation(); deleteTransaction(${tx.id})" class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" aria-label="Delete">
              <i data-lucide="trash" class="w-4 h-4" style="color: color-mix(in srgb, var(--danger) 90%, var(--fg));"></i>
            </button>
          </div>
        </div>
      `;
    }

    let openTransactionDetailsId = null;

    function buildReceiptText(tx) {
      if (!tx) return '';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const lines = [];
      lines.push(`${t('appName')} â€” ${t('transaction')}`);
      lines.push('------------------');
      lines.push(`${t('itemName')}: ${tx.item || ''}`);
      lines.push(`${t('quantity')}: ${tx.quantity || 1}`);
      lines.push(`${t('total')}: ${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`);
      lines.push(`${t('date')}: ${tx.date || ''}`);
      if (tx.isCredit) {
        lines.push(`${t('clientName')}: ${tx.clientName || ''}`);
        lines.push(`${t('amountPaid')}: ${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`);
        lines.push(`${t('remaining')}: ${formatMoney(remaining)} ${currencySymbols[state.currency]}`);
      } else {
        lines.push(t('paidLabel'));
      }
      lines.push('------------------');
      return lines.join('\n');
    }

    async function shareReceiptText(text) {
      try {
        if (!text) return;
        if (window.isNativeApp) {
          // Delegate to native share sheet.
          if (window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'SHARE_TEXT', payload: { title: t('receipt'), text } }));
          }
          return;
        }

        if (navigator.share) {
          await navigator.share({ title: t('receipt'), text });
        } else {
          await navigator.clipboard.writeText(text);
          showToast(t('copied'), 'success');
        }
      } catch {
        // ignore
      }
    }

    async function downloadReceiptText(fileName, text) {
      if (!text) return;
      const name = fileName || `tijarati_receipt_${Date.now()}.txt`;
      if (window.isNativeApp) {
        const res = await API.saveFileWithType(name, text, 'text/plain');
        if (res && res.message) showToast(res.message, 'success');
        return;
      }
      await API.saveFileWithType(name, text, 'text/plain');
      showToast(t('saved'), 'success');
    }

    function openTransactionDetails(id, tab = 'details') {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      openTransactionDetailsId = id;

      const isSale = tx.type === 'sale';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const unitBase = (tx.unitPriceBase && tx.unitPriceBase > 0) ? tx.unitPriceBase : ((tx.quantity || 1) ? (tx.amountBase || 0) / (tx.quantity || 1) : 0);

      document.getElementById('txd-item').textContent = tx.item || '';
      document.getElementById('txd-type').textContent = isSale ? t('filterSales') : t('filterPurchases');
      document.getElementById('txd-date').textContent = tx.date || '';

      const clientRow = document.getElementById('txd-client-row');
      if (tx.isCredit) {
        clientRow.classList.remove('hidden');
        document.getElementById('txd-client').textContent = tx.clientName || '';
      } else {
        clientRow.classList.add('hidden');
        document.getElementById('txd-client').textContent = '';
      }

      document.getElementById('txd-qty').textContent = String(tx.quantity || 1);
      document.getElementById('txd-unit').textContent = `${formatMoney(unitBase)} ${currencySymbols[state.currency]}`;
      document.getElementById('txd-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;

      const creditBox = document.getElementById('txd-credit-box');
      const creditActions = document.getElementById('txd-credit-actions');
      const settleBtn = document.getElementById('txd-settle');
      const clearBtn = document.getElementById('txd-clear-reminder');

      if (tx.isCredit) {
        creditBox.classList.remove('hidden');
        creditActions.classList.remove('hidden');
        document.getElementById('txd-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-reminder').textContent = tx.dueDate || t('noReminder');

        // Toggle clear reminder
        if (tx.dueDate) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');

        // Show settle only when still pending
        if (!tx.isFullyPaid && remaining > 0.0001) settleBtn.classList.remove('hidden');
        else settleBtn.classList.add('hidden');
      } else {
        creditBox.classList.add('hidden');
        creditActions.classList.add('hidden');
        settleBtn.classList.add('hidden');
      }

      const receipt = buildReceiptText(tx);
      document.getElementById('txd-receipt').textContent = receipt;

      document.getElementById('txd-share').onclick = async () => shareReceiptText(receipt);
      document.getElementById('txd-download').onclick = async () => downloadReceiptText(`tijarati_receipt_${tx.id}.txt`, receipt);
      document.getElementById('txd-delete').onclick = () => {
        closeTransactionDetails();
        deleteTransaction(tx.id);
      };

      // Credit-only actions
      document.getElementById('txd-set-reminder').onclick = () => pickDebtReminderDate(tx.id);
      clearBtn.onclick = async () => { await clearDebtReminder(tx.id); refreshTransactionDetails(tx.id); };
      settleBtn.onclick = () => settleDebt(tx.id);

      const modal = document.getElementById('transaction-details-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();

      // For now tab only drives intent (receipt icon opens modal); could be expanded later.
      void tab;
    }

    function refreshTransactionDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      if (tx.isCredit) {
        document.getElementById('txd-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-reminder').textContent = tx.dueDate || t('noReminder');
        const clearBtn = document.getElementById('txd-clear-reminder');
        if (tx.dueDate) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');
        const settleBtn = document.getElementById('txd-settle');
        if (!tx.isFullyPaid && remaining > 0.0001) settleBtn.classList.remove('hidden');
        else settleBtn.classList.add('hidden');
      }
      const receipt = buildReceiptText(tx);
      document.getElementById('txd-receipt').textContent = receipt;
    }

    function closeTransactionDetails() {
      const modal = document.getElementById('transaction-details-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      openTransactionDetailsId = null;
    }

    function emptyState(icon, text) {
      return `
        <div class="card p-6 text-center" style="background: color-mix(in srgb, var(--surface) 70%, transparent);">
          <div class="mx-auto w-12 h-12 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--muted);">
            <i data-lucide="${icon}" class="w-6 h-6"></i>
          </div>
          <div class="mt-3 text-sm font-black">${escapeHtml(text)}</div>
        </div>
      `;
    }

    // ==========================
    // Transaction flow
    // ==========================
    function openQuickAdd() {
      const q = document.getElementById('quick-add');
      q.classList.remove('hidden');
      q.classList.add('flex');
      lucide.createIcons();
    }

    function closeQuickAdd() {
      const q = document.getElementById('quick-add');
      q.classList.add('hidden');
      q.classList.remove('flex');
    }

    function startFlow(type) {
      state.currentFlow = type;

      // reset
      document.getElementById('tx-item').value = '';
      document.getElementById('tx-price').value = '';
      document.getElementById('tx-qty').value = '1';
      document.getElementById('tx-client').value = '';
      document.getElementById('tx-paid-amount').value = '';
      const due = document.getElementById('tx-due-date');
      if (due) due.value = '';
      document.getElementById('tx-date').value = new Date().toISOString().slice(0, 10);

      // header
      const header = document.getElementById('modal-header');
      const title = document.getElementById('modal-title');
      if (type === 'sale') {
        header.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-2))';
        title.textContent = t('newSale');
        generateSuggestions(getSuggestions('sale'));
      } else {
        header.style.background = 'linear-gradient(135deg, #334155, #0f172a)';
        title.textContent = t('newPurchase');
        generateSuggestions(getSuggestions('purchase'));
      }

      setPaymentType('paid');

      const modal = document.getElementById('transaction-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      updateTxTotalPreview();
      lucide.createIcons();

      // focus
      setTimeout(() => document.getElementById('tx-item').focus(), 60);
    }

    function closeModal() {
      const modal = document.getElementById('transaction-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function setPaymentType(type) {
      state.paymentType = type;

      const paid = document.getElementById('btn-paid');
      const credit = document.getElementById('btn-credit');
      const details = document.getElementById('credit-details');

      const active = {
        background: 'linear-gradient(135deg, var(--primary), var(--primary-2))',
        color: '#fff',
        border: '1px solid color-mix(in srgb, var(--primary-2) 22%, transparent)'
      };

      const inactive = {
        background: 'transparent',
        color: 'var(--muted)',
        border: '1px solid transparent'
      };

      const apply = (el, st) => {
        el.style.background = st.background;
        el.style.color = st.color;
        el.style.border = st.border;
      };

      if (type === 'paid') {
        apply(paid, active);
        apply(credit, inactive);
        details.classList.add('hidden');
      } else {
        // use warn accent for credit
        paid.style.background = 'transparent';
        paid.style.color = 'var(--muted)';
        paid.style.border = '1px solid transparent';

        credit.style.background = 'linear-gradient(135deg, color-mix(in srgb, var(--warn) 85%, #fb7185), var(--warn))';
        credit.style.color = '#1f2937';
        credit.style.border = '1px solid color-mix(in srgb, var(--warn) 22%, transparent)';

        details.classList.remove('hidden');
      }
      updateTxTotalPreview();
    }

    function generateSuggestions(items) {
      const container = document.getElementById('quick-suggestions');
      container.innerHTML = items.map(i => {
        const safe = escapeHtml(i);
        return `<button class="chip" onclick="document.getElementById('tx-item').value='${i.replace(/'/g, "\\'")}';">${safe}</button>`;
      }).join('');
    }

    function getSuggestions(kind) {
      const lang = state.language;
      const suggestions = {
        darija: {
          sale: ['Ø®Ø¨Ø²', 'Ø­Ù„ÙŠØ¨', 'Ù‚Ù‡ÙˆØ©', 'Ù…Ø³Ù…Ù†', 'Ø¹ØµÙŠØ±', 'Ù…Ø§Ø¡'],
          purchase: ['Ø·Ø­ÙŠÙ†', 'Ø²ÙŠØª', 'Ø³ÙƒØ±', 'Ø®Ø¶Ø±Ø©', 'Ø¨ÙˆØ·Ø©', 'Ù‚Ù‡ÙˆØ©']
        },
        arabic: {
          sale: ['Ø®Ø¨Ø²', 'Ø­Ù„ÙŠØ¨', 'Ù‚Ù‡ÙˆØ©', 'Ù…Ø³Ù…Ù†', 'Ø¹ØµÙŠØ±', 'Ù…Ø§Ø¡'],
          purchase: ['Ø·Ø­ÙŠÙ†', 'Ø²ÙŠØª', 'Ø³ÙƒØ±', 'Ø®Ø¶Ø±Ø©', 'ØºØ§Ø²', 'Ù‚Ù‡ÙˆØ©']
        },
        english: {
          sale: ['Bread', 'Milk', 'Coffee', 'Juice', 'Water', 'Tea'],
          purchase: ['Flour', 'Oil', 'Sugar', 'Vegetables', 'Gas', 'Coffee']
        },
        french: {
          sale: ['Pain', 'Lait', 'CafÃ©', 'Jus', 'Eau', 'ThÃ©'],
          purchase: ['Farine', 'Huile', 'Sucre', 'LÃ©gumes', 'Gaz', 'CafÃ©']
        }
      };
      const group = suggestions[lang] || suggestions.darija;
      return group[kind] || group.sale;
    }

    function updateTxTotalPreview() {
      const price = parseFloat(document.getElementById('tx-price').value) || 0;
      const qty = clamp(parseFloat(document.getElementById('tx-qty').value) || 1, 1, 1000000);
      const totalInSelectedCurrency = price * qty;
      const baseTotal = baseFromCurrentCurrency(totalInSelectedCurrency);
      document.getElementById('tx-total-preview').textContent = formatMoney(baseTotal);

      // If credit and paidAmount empty, suggest 0; if paid and paidAmount exists, ignore
      if (state.paymentType === 'credit') {
        const pa = document.getElementById('tx-paid-amount');
        if (pa && pa.value === '') {
          // keep empty
        }
      }
      applyCurrency();
    }

    function saveTransaction() {
      const item = (document.getElementById('tx-item').value || '').trim();
      const unitPrice = parseFloat(document.getElementById('tx-price').value);
      const qty = clamp(parseFloat(document.getElementById('tx-qty').value) || 1, 1, 1000000);
      const date = document.getElementById('tx-date').value;

      if (!item || !unitPrice || !date) {
        showToast(t('fillAll'), 'error');
        return;
      }

      const totalSelected = unitPrice * qty;
      const amountBase = baseFromCurrentCurrency(totalSelected);

      const isCredit = state.paymentType === 'credit';
      let client = '';
      let paidSelected = totalSelected;
      let dueDate = '';

      if (isCredit) {
        client = (document.getElementById('tx-client').value || '').trim();
        paidSelected = parseFloat(document.getElementById('tx-paid-amount').value) || 0;
        dueDate = (document.getElementById('tx-due-date')?.value || '').trim();
        if (!client) {
          showToast(t('needClient'), 'error');
          return;
        }
      }

      paidSelected = clamp(paidSelected, 0, totalSelected);
      const paidAmountBase = baseFromCurrentCurrency(paidSelected);

      const tx = {
        id: Date.now(),
        createdAt: Date.now(),
        type: state.currentFlow,
        item,
        quantity: qty,
        unitPriceBase: baseFromCurrentCurrency(unitPrice),
        amountBase,
        date,
        isCredit,
        clientName: client,
        paidAmountBase,
        isFullyPaid: !isCredit || (paidSelected >= totalSelected - 1e-9),
        dueDate: isCredit ? dueDate : '',
        reminderId: null
      };

      state.transactions.push(tx);
      saveState();
      if (window.isNativeApp) {
        API.saveTransaction(tx);
        // schedule reminder (if any) and persist reminderId
        if (tx.isCredit && tx.dueDate) {
          scheduleOrUpdateDebtReminder(tx).then(() => {
            API.saveTransaction(tx);
            saveState();
          });
        }
      }
      closeModal();
      updateDashboard();
      showToast(t('saved'), 'success');
    }

    // ==========================
    // Debt reminders
    // ==========================
    let pendingReminderTxId = null;

    function pickDebtReminderDate(txId) {
      pendingReminderTxId = txId;
      const picker = document.getElementById('debt-reminder-picker');
      if (!picker) return;
      const tx = state.transactions.find(t => t.id === txId);
      picker.value = (tx && tx.dueDate) ? tx.dueDate : '';
      if (picker.showPicker) picker.showPicker();
      else picker.click();
    }

    async function scheduleOrUpdateDebtReminder(tx) {
      if (!window.isNativeApp) return;
      if (!tx || !tx.isCredit) return;

      // Cancel old reminder
      if (tx.reminderId) {
        try { await API.cancelDebtReminder(tx.reminderId); } catch { }
        tx.reminderId = null;
      }

      if (!tx.dueDate) return;
      const trigger = new Date(tx.dueDate + 'T09:00:00');
      if (Number.isNaN(trigger.getTime())) return;
      // If date is in the past, don't schedule.
      if (trigger.getTime() < Date.now() + 60 * 1000) return;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const title = `${t('appName')} â€” ${tx.type === 'sale' ? t('filterSales') : t('filterPurchases')}`;
      const body = `${tx.clientName || ''} â€¢ ${tx.item || ''} â€¢ ${t('remaining')}: ${formatMoney(remaining)} ${currencySymbols[state.currency]}`;

      const res = await API.scheduleDebtReminder({
        txId: tx.id,
        timestamp: trigger.getTime(),
        title,
        body
      });
      if (res && res.success && res.reminderId) {
        tx.reminderId = res.reminderId;
      }
    }

    async function setDebtDueDate(txId, dueDate) {
      const tx = state.transactions.find(t => t.id === txId);
      if (!tx) return;
      tx.dueDate = (dueDate || '').trim();
      await scheduleOrUpdateDebtReminder(tx);
      saveState();
      if (window.isNativeApp) await API.saveTransaction(tx);
      renderDebts(true);
      updateDashboard();
      if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) {
        refreshDebtDetails(txId);
      }
      if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) {
        refreshTransactionDetails(txId);
      }
    }

    async function clearDebtReminder(txId) {
      const tx = state.transactions.find(t => t.id === txId);
      if (!tx) return;
      tx.dueDate = '';
      await scheduleOrUpdateDebtReminder(tx);
      saveState();
      if (window.isNativeApp) await API.saveTransaction(tx);
      renderDebts(true);
      updateDashboard();
    }

    // live total preview
    function bindTxInputs() {
      ['tx-price', 'tx-qty'].forEach(id => {
        const el = document.getElementById(id);
        el && el.addEventListener('input', updateTxTotalPreview);
      });
      const paid = document.getElementById('tx-paid-amount');
      paid && paid.addEventListener('input', updateTxTotalPreview);
    }

    // ==========================
    // History
    // ==========================
    const historyFilters = [
      { key: 'all', labelKey: 'filterAll' },
      { key: 'sale', labelKey: 'filterSales' },
      { key: 'purchase', labelKey: 'filterPurchases' },
      { key: 'debt', labelKey: 'filterCredits' },
    ];

    function renderHistoryFilters(active = state.historyFilter || 'all') {
      state.historyFilter = active;
      saveState();
      const container = document.getElementById('history-filters');
      if (!container) return;
      container.innerHTML = historyFilters.map(f => {
        const isActive = f.key === active;
        return `<button class="chip ${isActive ? 'active' : ''}" onclick="filterHistory('${f.key}')">${escapeHtml(t(f.labelKey))}</button>`;
      }).join('');
    }

    function renderHistory() {
      filterHistory(state.historyFilter || 'all', { silentUI: false });
    }

    function filterHistory(filter, { silentUI = true } = {}) {
      if (!silentUI) renderHistoryFilters(filter);
      else {
        state.historyFilter = filter;
        saveState();
        renderHistoryFilters(filter);
      }

      const search = (document.getElementById('history-search')?.value || '').trim().toLowerCase();
      let data = [...state.transactions].sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.createdAt || 0) - (a.createdAt || 0));

      if (filter === 'sale') data = data.filter(t => t.type === 'sale');
      if (filter === 'purchase') data = data.filter(t => t.type === 'purchase');
      if (filter === 'debt') data = data.filter(t => t.isCredit && !t.isFullyPaid);

      if (search) {
        data = data.filter(t =>
          (t.item || '').toLowerCase().includes(search) ||
          (t.clientName || '').toLowerCase().includes(search)
        );
      }

      const container = document.getElementById('full-history-list');
      if (!container) return;

      if (data.length === 0) {
        container.innerHTML = emptyState('inbox', t('emptyHistory'));
        lucide.createIcons();
        return;
      }

      // Group by date
      const groups = {};
      for (const tx of data) {
        const d = tx.date || 'â€”';
        if (!groups[d]) groups[d] = [];
        groups[d].push(tx);
      }

      const dates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      container.innerHTML = dates.map(d => {
        const items = groups[d].map(tx => createTransactionRow(tx, { compact: false })).join('');
        return `
          <div>
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs font-black" style="color: var(--muted);">${escapeHtml(d)}</div>
              <div class="text-[11px] font-bold" style="color: var(--muted);">${groups[d].length}</div>
            </div>
            <div class="space-y-3">${items}</div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    // ==========================
    // Debts
    // ==========================
    function renderDebts(force = false) {
      const search = (document.getElementById('debts-search')?.value || '').trim().toLowerCase();
      const container = document.getElementById('debts-list');
      if (!container) return;

      const debts = state.transactions
        .filter(t => t.isCredit && !t.isFullyPaid)
        .filter(t => !search || (t.clientName || '').toLowerCase().includes(search) || (t.item || '').toLowerCase().includes(search))
        .sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.createdAt || 0) - (a.createdAt || 0));

      const total = debts.reduce((sum, t) => sum + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);
      document.getElementById('debts-total').textContent = formatMoney(total);

      if (debts.length === 0) {
        container.innerHTML = emptyState('shield-check', t('emptyDebts'));
        lucide.createIcons();
        return;
      }

      container.innerHTML = debts.map(tx => {
        const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
        const typeIsSale = tx.type === 'sale';
        const typeLabel = typeIsSale ? t('filterSales') : t('filterPurchases');
        const typeAccent = typeIsSale ? 'var(--success)' : 'var(--danger)';
        return `
          <div class="card p-4 flex items-center justify-between gap-3 animate-in cursor-pointer" onclick="openDebtDetails(${tx.id})">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--warn) 14%, transparent); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: var(--warn);">
                  <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="font-black truncate flex-1 min-w-0">${escapeHtml(tx.clientName || '')}</div>
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-black flex-none" style="background: color-mix(in srgb, ${typeAccent} 12%, transparent); color: ${typeAccent}; border: 1px solid color-mix(in srgb, ${typeAccent} 18%, var(--border));">${escapeHtml(typeLabel)}</span>
                  </div>
                  <div class="text-xs font-bold truncate" style="color: var(--muted);">${escapeHtml(tx.item || '')} â€¢ ${escapeHtml(tx.date || '')}</div>
                  <div class="mt-1 text-[11px] font-bold truncate" style="color: var(--muted);">${escapeHtml(t('debtDueDate'))}: ${escapeHtml(tx.dueDate || t('noReminder'))}</div>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-end gap-2 flex-none">
              <div class="font-black" style="color: var(--warn);">${formatMoney(remaining)} <span class="text-[10px] font-black currency-symbol" style="color: color-mix(in srgb, var(--warn) 70%, var(--muted));"></span></div>
              <div class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="${escapeHtml(t('debtDetailsTitle'))}">
                <i data-lucide="chevron-right" class="w-4 h-4" style="color: var(--muted);"></i>
              </div>
            </div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    function settleDebt(id) {
      const txIndex = state.transactions.findIndex(t => t.id === id);
      if (txIndex < 0) return;

      openConfirm({
        title: t('confirmTitle'),
        message: t('settleDebtConfirmMessage'),
        confirmText: t('confirmAction'),
        danger: false,
        onConfirm: async () => {
          const tx = state.transactions[txIndex];
          closeDebtDetails();
          // Clear reminders when settling
          if (tx.reminderId && window.isNativeApp) {
            try { await API.cancelDebtReminder(tx.reminderId); } catch { }
          }
          tx.reminderId = null;
          tx.dueDate = '';
          tx.paidAmountBase = tx.amountBase;
          tx.isFullyPaid = true;
          saveState();
          if (window.isNativeApp) API.saveTransaction(tx);
          renderDebts();
          updateDashboard();
          showToast('âœ…', 'success');
        }
      });
    }

    function openDebtDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));

      document.getElementById('debt-details-client').textContent = tx.clientName || '';
      document.getElementById('debt-details-item').textContent = tx.item || '';
      document.getElementById('debt-details-date').textContent = tx.date || '';
      document.getElementById('debt-details-type').textContent = tx.type === 'sale' ? t('filterSales') : t('filterPurchases');
      document.getElementById('debt-details-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-reminder').textContent = tx.dueDate || t('noReminder');

      const setBtn = document.getElementById('debt-details-set-reminder');
      const clearBtn = document.getElementById('debt-details-clear-reminder');
      const settleBtn = document.getElementById('debt-details-settle');

      setBtn.onclick = (e) => { e && e.stopPropagation && e.stopPropagation(); pickDebtReminderDate(tx.id); };
      clearBtn.onclick = async (e) => { e && e.stopPropagation && e.stopPropagation(); await clearDebtReminder(tx.id); refreshDebtDetails(tx.id); };
      settleBtn.onclick = (e) => { e && e.stopPropagation && e.stopPropagation(); settleDebt(tx.id); };

      if (tx.dueDate) clearBtn.classList.remove('hidden');
      else clearBtn.classList.add('hidden');

      const modal = document.getElementById('debt-details-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
    }

    function refreshDebtDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      document.getElementById('debt-details-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-reminder').textContent = tx.dueDate || t('noReminder');

      const clearBtn = document.getElementById('debt-details-clear-reminder');
      if (tx.dueDate) clearBtn.classList.remove('hidden');
      else clearBtn.classList.add('hidden');
    }

    function closeDebtDetails() {
      const modal = document.getElementById('debt-details-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ==========================
    // Stock & partners
    // ==========================
    function renderPartnersAndStock() {
      switchPartnerTab(state.partnerTab || 'stock');
    }

    function switchPartnerTab(tab) {
      state.partnerTab = tab;
      saveState();

      const stockBtn = document.getElementById('tab-stock');
      const partnersBtn = document.getElementById('tab-partners');
      const stockView = document.getElementById('stock-view');
      const partnersView = document.getElementById('partners-view');

      const active = (btn) => {
        btn.style.background = 'var(--surface)';
        btn.style.border = '1px solid var(--border)';
        btn.style.color = 'var(--fg)';
      };
      const inactive = (btn) => {
        btn.style.background = 'transparent';
        btn.style.border = '1px solid transparent';
        btn.style.color = 'var(--muted)';
      };

      if (tab === 'stock') {
        active(stockBtn); inactive(partnersBtn);
        stockView.classList.remove('hidden');
        partnersView.classList.add('hidden');
        renderStock();
      } else {
        active(partnersBtn); inactive(stockBtn);
        partnersView.classList.remove('hidden');
        stockView.classList.add('hidden');
        renderPartners();
      }
      lucide.createIcons();
    }

    function renderStock() {
      const inventory = {};
      state.transactions.forEach(t => {
        const name = (t.item || '').toLowerCase().trim();
        if (!name) return;
        if (!inventory[name]) inventory[name] = 0;
        if (t.type === 'purchase') inventory[name] += (t.quantity || 1);
        if (t.type === 'sale') inventory[name] -= (t.quantity || 1);
      });

      const container = document.getElementById('stock-view');
      const items = Object.entries(inventory)
        .filter(([_, qty]) => qty !== 0)
        .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));

      if (items.length === 0) {
        container.innerHTML = emptyState('package', state.language === 'english' ? 'No stock data yet.' : state.language === 'french' ? 'Aucune donnÃ©e de stock.' : 'Ù…Ø§ ÙƒØ§ÙŠÙ†Ø§Ø´ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠØ§Ù„ Ø§Ù„Ø³ØªÙˆÙƒ Ø¯Ø§Ø¨Ø§.');
        lucide.createIcons();
        return;
      }

      container.innerHTML = items.map(([name, qty]) => {
        const positive = qty > 0;
        const accent = positive ? 'var(--success)' : 'var(--danger)';
        return `
          <div class="card p-4 flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, ${accent} 12%, transparent); border: 1px solid color-mix(in srgb, ${accent} 18%, var(--border)); color: ${accent};">
                <i data-lucide="package" class="w-5 h-5"></i>
              </div>
              <div class="font-black capitalize truncate">${escapeHtml(name)}</div>
            </div>
            <span class="px-3 py-1 rounded-2xl font-black" style="background: color-mix(in srgb, ${accent} 12%, transparent); border: 1px solid color-mix(in srgb, ${accent} 18%, var(--border)); color: ${accent};">
              ${qty}
            </span>
          </div>
        `;
      }).join('');

      lucide.createIcons();
    }

    function renderPartners() {
      const container = document.getElementById('partners-list');
      const summary = document.getElementById('partners-summary');

      const totalSales = state.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + (t.amountBase || 0), 0);
      const totalPurchases = state.transactions.filter(t => t.type === 'purchase').reduce((s, t) => s + (t.amountBase || 0), 0);
      const profit = totalSales - totalPurchases;
      const netProfit = Math.max(0, profit);

      summary.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs font-extrabold" style="color: var(--muted);">${state.language === 'english' ? 'Estimated net profit' : state.language === 'french' ? 'BÃ©nÃ©fice estimÃ©' : 'Ø§Ù„Ø±Ø¨Ø­ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)'}</div>
            <div class="mt-1 text-2xl font-black" style="color: var(--primary-2);">${formatMoney(netProfit)} <span class="text-sm currency-symbol"></span></div>
          </div>
          <div class="w-12 h-12 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">
            <i data-lucide="pie-chart" class="w-6 h-6"></i>
          </div>
        </div>
      `;

      if (!state.partners.length) {
        container.innerHTML = emptyState('users', state.language === 'english' ? 'Add partners to split profit.' : state.language === 'french' ? 'Ajoutez des partenaires.' : 'Ø²ÙŠØ¯ Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ Ø¨Ø§Ø´ ÙŠØªÙ‚Ø³Ù… Ø§Ù„Ø±Ø¨Ø­.');
        applyCurrency();
        lucide.createIcons();
        return;
      }

      container.innerHTML = state.partners.map(p => {
        const percent = clamp(parseFloat(p.percent) || 0, 0, 100);
        const share = (netProfit * percent) / 100;
        return `
          <div class="card p-4 flex items-center justify-between">
            <div>
              <div class="font-black">${escapeHtml(p.name || '')}</div>
              <div class="text-xs font-bold" style="color: var(--muted);">${percent}%</div>
            </div>
            <div class="text-left">
              <div class="font-black" style="color: var(--primary-2);">${formatMoney(share)} <span class="text-[10px] font-black currency-symbol"></span></div>
              <button onclick="removePartner('${(p.name || '').replace(/'/g, "\\'")}')" class="mt-1 text-xs font-black" style="color: color-mix(in srgb, var(--danger) 85%, var(--fg));">${state.language === 'english' ? 'Remove' : state.language === 'french' ? 'Supprimer' : 'Ø­Ø°Ù'}</button>
            </div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    function addPartner() {
      const name = (document.getElementById('partner-name').value || '').trim();
      const percent = parseFloat(document.getElementById('partner-percent').value);
      if (!name || !percent) return;
      const newP = { id: Date.now(), name, percent: clamp(percent, 0, 100), createdAt: Date.now() };
      state.partners.push(newP);
      saveState();
      if (window.isNativeApp) API.savePartner(newP);
      document.getElementById('partner-name').value = '';
      document.getElementById('partner-percent').value = '';
      renderPartners();
      showToast(state.language === 'english' ? 'Partner added' : state.language === 'french' ? 'Partenaire ajoutÃ©' : 'ØªØ²Ø§Ø¯ Ø§Ù„Ø´Ø±ÙŠÙƒ', 'success');
    }

    function removePartner(name) {
      const p = state.partners.find(p => p.name === name);
      if (p && p.id && window.isNativeApp) API.deletePartner(p.id);
      state.partners = state.partners.filter(p => p.name !== name);
      saveState();
      renderPartners();
    }

    // ==========================
    // Export / Import / Clear
    // ==========================
    async function exportData() {
      const timestamp = new Date().toISOString().split('T')[0];
      const fileName = `tijarati_backup_${timestamp}.json`;
      const content = JSON.stringify(state, null, 2);

      const result = await API.saveFile(fileName, content);
      if (result && result.success) {
        showToast(t('saved') || 'Exported', 'success');
      } else {
        showToast('Failed to export', 'error');
      }
    }

    async function importData(event) {
      let content = null;

      if (window.isNativeApp) {
        const result = await API.pickFile();
        if (result && result.success && result.content) {
          content = result.content;
        } else {
          return;
        }
      } else {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          processImport(String(reader.result || '{}'), event);
        };
        reader.readAsText(file);
        return;
      }

      processImport(content, event);
    }

    function processImport(content, event) {
      try {
        const incoming = JSON.parse(content);
        state = {
          ...state,
          ...incoming,
          transactions: Array.isArray(incoming.transactions) ? incoming.transactions : state.transactions,
          partners: Array.isArray(incoming.partners) ? incoming.partners : state.partners
        };
        saveState();
        applyTheme();
        applyLanguage();
        applyCurrency();
        renderAll();
        showToast('Imported', 'success');
      } catch {
        showToast('Invalid file', 'error');
      } finally {
        if (event && event.target) event.target.value = '';
      }
    }

    // ==========================
    // Clear data (with UX)
    // ==========================
    let blockingOverlayEl = null;

    function ensureBlockingOverlay() {
      if (blockingOverlayEl) return blockingOverlayEl;

      const el = document.createElement('div');
      el.id = 'blocking-overlay';
      el.className = 'fixed inset-0 hidden items-center justify-center p-5';
      el.style.cssText = 'z-index: 9999; background: rgba(0,0,0,0.55); backdrop-filter: blur(12px);';

      el.innerHTML = `
        <div class="card p-6 w-full max-w-sm animate-pop" style="border-radius: 26px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <div class="flex items-center gap-3">
            <div id="blocking-overlay-icon" class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--primary-2);">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.25" />
                <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-base font-black" id="blocking-overlay-title">${escapeHtml(t('clearingData'))}</div>
              <div class="mt-1 text-xs font-bold" style="color: var(--muted);" id="blocking-overlay-sub">${escapeHtml(t('deleteWarning'))}</div>
            </div>
          </div>
        </div>
      `;

      // Simple spinner animation
      try {
        const style = document.createElement('style');
        style.textContent = `
          @keyframes tijarati-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
          #blocking-overlay-icon svg { animation: tijarati-spin 0.85s linear infinite; }
          #blocking-overlay.flex { display: flex !important; }
        `;
        document.head.appendChild(style);
      } catch { }

      document.body.appendChild(el);
      blockingOverlayEl = el;
      return el;
    }

    function showBlockingOverlay(title, subText) {
      const el = ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const subEl = document.getElementById('blocking-overlay-sub');
      if (titleEl) titleEl.textContent = title || t('clearingData');
      if (subEl) subEl.textContent = subText || '';
      el.classList.remove('hidden');
      el.classList.add('flex');
    }

    function hideBlockingOverlay() {
      const el = ensureBlockingOverlay();
      el.classList.add('hidden');
      el.classList.remove('flex');
    }

    function setBlockingOverlayDone(title) {
      ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const iconWrap = document.getElementById('blocking-overlay-icon');
      if (titleEl) titleEl.textContent = title || t('clearedDone');
      if (iconWrap) {
        iconWrap.style.color = 'var(--success)';
        iconWrap.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i>';
        lucide.createIcons();
      }
    }

    function setBlockingOverlayError(title) {
      ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const iconWrap = document.getElementById('blocking-overlay-icon');
      if (titleEl) titleEl.textContent = title || t('clearFailed');
      if (iconWrap) {
        iconWrap.style.color = 'var(--danger)';
        iconWrap.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
        lucide.createIcons();
      }
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function withTimeout(promise, ms) {
      let timer;
      const timeoutPromise = new Promise((_, reject) => {
        timer = setTimeout(() => reject(new Error('timeout')), ms);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        clearTimeout(timer);
      }
    }

    function clearAllLocalTijaratiKeys() {
      // Clear current + legacy keys to make web + native WebView consistent.
      try {
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.startsWith('tijarati')) localStorage.removeItem(k);
        }
      } catch {
        try { localStorage.removeItem(STORAGE_KEY); } catch { }
        try { localStorage.removeItem('tijarati_v2'); } catch { }
      }
    }

    async function clearAllData() {
      console.log('ğŸ”´ clearAllData CALLED');
      
      try {
        const startedAt = Date.now();
        const MIN_SPINNER_MS = 900;
        const DONE_VISIBLE_MS = 1000;

        // 1. Immediately reset in-memory state so UI shows empty
        console.log('ğŸ”´ Step 1: Resetting state...');
        console.log('ğŸ”´ Before reset - transactions:', state.transactions.length, 'partners:', state.partners.length);
        state.transactions = [];
        state.partners = [];
        state.currentFlow = null;
        state.paymentType = 'paid';
        console.log('ğŸ”´ After reset - transactions:', state.transactions.length, 'partners:', state.partners.length);

        // 2. Re-render UI to show empty state (removes old elements from DOM)
        console.log('ğŸ”´ Step 2: Calling renderAll()...');
        renderAll();
        lucide.createIcons();
        console.log('ğŸ”´ renderAll() completed');

        // 3. Show loading overlay and give the browser a moment to paint it
        console.log('ğŸ”´ Step 3: Showing blocking overlay...');
        showBlockingOverlay(t('clearingData'), '');
        try {
          await new Promise((resolve) => requestAnimationFrame(() => resolve()));
        } catch {
          await sleep(50);
        }
        await sleep(150);
        console.log('ğŸ”´ Overlay should be visible now');

        // 4. Clear native data
        let nativeOk = true;
        console.log('ğŸ”´ Step 5: Checking if native app...', window.isNativeApp);
        if (window.isNativeApp) {
          try {
            console.log('ğŸ”´ Calling API.clearAllData()...');
            const res = await withTimeout(API.clearAllData(), 5000);
            console.log('ğŸ”´ API.clearAllData() response:', res);
            if (res && res.success === false) nativeOk = false;
          } catch (err) {
            console.log('ğŸ”´ API.clearAllData() ERROR:', err);
            nativeOk = false;
          }
        }

        // 5. Clear all localStorage keys
        console.log('ğŸ”´ Step 6: Clearing localStorage...');
        clearAllLocalTijaratiKeys();
        console.log('ğŸ”´ localStorage cleared');

        // Ensure the spinner is visible long enough (otherwise it flips to Done too fast to notice)
        const elapsed = Date.now() - startedAt;
        if (elapsed < MIN_SPINNER_MS) {
          console.log('ğŸ”´ Waiting extra for spinner visibility:', MIN_SPINNER_MS - elapsed);
          await sleep(MIN_SPINNER_MS - elapsed);
        }

        // 6. Show completion state
        console.log('ğŸ”´ Step 7: Showing completion state, nativeOk:', nativeOk);
        if (nativeOk) setBlockingOverlayDone(t('clearedDone'));
        else setBlockingOverlayError(t('clearFailed'));
        console.log('ğŸ”´ Completion state shown');

        // 7. Keep the result visible, then refresh UI.
        // On native WebView, location.reload can be flaky and may leave the overlay stuck.
        console.log('ğŸ”´ Step 8: Sleeping before finishing...');
        await sleep(DONE_VISIBLE_MS);
        if (window.isNativeApp) {
          console.log('ğŸ”´ Step 9: Native app - hiding overlay and re-rendering');
          hideBlockingOverlay();
          renderAll();
          lucide.createIcons();
        } else {
          console.log('ğŸ”´ Step 9: Web - reloading page');
          location.reload();
        }
      } catch (err) {
        console.error('ğŸ”´ğŸ”´ğŸ”´ clearAllData ERROR:', err);
        alert('ERROR in clearAllData: ' + err.message);
      }
    }

    // ==========================
    // Confirm modal
    // ==========================
    let confirmAction = null;

    function openConfirm({ title, message, confirmText, danger, onConfirm }) {
      confirmAction = onConfirm || null;
      document.getElementById('confirm-title').textContent = title || t('confirmTitle');
      document.getElementById('confirm-message').textContent = message || '';
      const actionBtn = document.getElementById('confirm-action');
      actionBtn.textContent = confirmText || t('confirmAction');
      actionBtn.style.background = danger
        ? 'linear-gradient(135deg, var(--danger), color-mix(in srgb, var(--danger) 70%, #7f1d1d))'
        : 'linear-gradient(135deg, var(--primary), var(--primary-2))';
      actionBtn.onclick = () => {
        const action = confirmAction;
        console.log('ğŸ”µ Confirm button clicked!');
        console.log('ğŸ”µ confirmAction:', action);
        closeConfirm();
        if (action) {
          console.log('ğŸ”µ Calling confirmAction...');
          action();
        } else {
          console.log('ğŸ”µ No confirmAction set!');
        }
      };

      const modal = document.getElementById('confirm-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
    }

    function closeConfirm() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      confirmAction = null;
    }

    // ==========================
    // Delete transaction
    // ==========================
    function deleteTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      openConfirm({
        title: t('deleteTransactionTitle'),
        message: `${tx.item} â€¢ ${tx.date}`,
        confirmText: t('delete'),
        danger: true,
        onConfirm: async () => {
          // Cancel reminder if it exists
          if (tx.reminderId && window.isNativeApp) {
            try { await API.cancelDebtReminder(tx.reminderId); } catch { }
          }
          if (window.isNativeApp) API.deleteTransaction(id);
          state.transactions = state.transactions.filter(t => t.id !== id);
          saveState();
          renderAll();
          showToast(t('deleted'), 'info');
        }
      });
    }

    // ==========================
    // Sharing
    // ==========================
    async function shareTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      const text = buildReceiptText(tx);
      await shareReceiptText(text);
    }

    // ==========================
    // Toast
    // ==========================
    let toastTimer = null;

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toast-message');
      const icon = document.getElementById('toast-icon');

      msg.textContent = message;
      const iconName = type === 'error' ? 'alert-circle' : type === 'info' ? 'info' : 'check-circle';
      const iconColor = type === 'error' ? 'var(--danger)' : type === 'info' ? 'var(--warn)' : 'var(--success)';
      icon.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
      icon.style.color = iconColor;
      lucide.createIcons();

      toast.classList.remove('opacity-0', '-translate-y-6');
      toast.classList.add('opacity-100', 'translate-y-0');

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toast.classList.add('opacity-0', '-translate-y-6');
        toast.classList.remove('opacity-100', 'translate-y-0');
      }, 2800);
    }

    // ==========================
    // Date header
    // ==========================
    function updateDateHeader() {
      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      const locale = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar-MA');
      const el = document.getElementById('current-date-header');
      if (el) el.textContent = new Date().toLocaleDateString(locale, options);
    }

    // ==========================
    // Render all
    // ==========================
    function renderAll() {
      updateDashboard();
      renderHistoryFilters(state.historyFilter || 'all');
      // only render heavy screens if active
      const active = document.querySelector('.screen.active')?.id;
      if (active === 'history-screen') renderHistory();
      if (active === 'debts-screen') renderDebts();
      if (active === 'partners-screen') renderPartnersAndStock();
      applyCurrency();
      lucide.createIcons();
    }

    // ==========================
    // Security
    // ==========================
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ==========================
    // Init
    // ==========================
    async function init() {
      loadState();

      if (window.isNativeApp) {
        API.init();
        try {
          const txs = await API.getTransactions();
          if (txs && Array.isArray(txs)) {
            state.transactions = txs;
          }
          const parts = await API.getPartners();
          if (parts && Array.isArray(parts)) {
            state.partners = parts;
          }
          saveState();
          renderAll();
        } catch (e) {
          // ignore sync errors
        }
      }

      // Theme
      applyTheme();
      document.getElementById('theme-toggle').addEventListener('click', cycleTheme);
      if (window.matchMedia) {
        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        const onChange = () => { if (state.theme === 'system') applyTheme(); };
        // Older Android WebView supports addListener/removeListener, not addEventListener.
        if (mql && typeof mql.addEventListener === 'function') mql.addEventListener('change', onChange);
        else if (mql && typeof mql.addListener === 'function') mql.addListener(onChange);
      }

      // i18n + currency
      applyLanguage();
      applyCurrency();

      // filters
      renderHistoryFilters(state.historyFilter || 'all');

      // bind transaction preview
      bindTxInputs();

      // bind debt reminder picker
      const picker = document.getElementById('debt-reminder-picker');
      if (picker) {
        picker.addEventListener('change', async () => {
          if (!pendingReminderTxId) return;
          const txId = pendingReminderTxId;
          pendingReminderTxId = null;
          const value = picker.value;
          picker.value = '';
          await setDebtDueDate(txId, value);
        });
      }

      // keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // close top-most
          if (!document.getElementById('confirm-modal').classList.contains('hidden')) return closeConfirm();
          if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) return closeDebtDetails();
          if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) return closeTransactionDetails();
          if (!document.getElementById('transaction-modal').classList.contains('hidden')) return closeModal();
          if (!document.getElementById('quick-add').classList.contains('hidden')) return closeQuickAdd();
          if (document.querySelector('.screen.active')?.id === 'settings-screen') return closeSettings();
        }
      });

      // Restore last screen (except settings)
      const target = (state.lastScreen && state.lastScreen !== 'settings-screen') ? state.lastScreen : 'home-screen';
      showScreen(target, { push: false });

      // loader out
      setTimeout(() => {
        const loader = document.getElementById('loading');
        if (!loader) return;
        loader.style.transition = 'opacity 220ms ease';
        loader.style.opacity = '0';
        setTimeout(() => { try { loader.remove(); } catch { } }, 240);
      }, 550);
    }

    async function initSafe() {
      try {
        await init();
      } catch (err) {
        // Ensure we never get stuck on the loader.
        try {
          const loader = document.getElementById('loading');
          if (loader) {
            loader.style.transition = 'opacity 220ms ease';
            loader.style.opacity = '0';
            setTimeout(() => { try { loader.remove(); } catch { } }, 240);
          }
        } catch { }
        try {
          if (typeof showToast === 'function') showToast(String(err?.message || err || 'Init error'), 'error');
        } catch { }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      initSafe();
    });
  </script>
</body>

</html>